<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 2px solid #b48c46; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    const GW = 1200, GH = 900, OFFSET_X = 400, OFFSET_Y = 150;

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            this.load.image('hero_Воин', 'assets/hero_warrior.png');
            this.load.image('hero_Маг', 'assets/hero_mage.png');
            this.load.image('hero_Лучник', 'assets/archer.png');
            this.load.image('hero_Ассасин', 'assets/assasin.png');
            this.load.image('mob_icon', 'assets/hero_warrior.png');
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => 
                this.load.image(`tile_${c}`, `assets/rune_${c.toLowerCase()}.png`)
            );
        }

        create() { this.showMenu(); }

        showMenu() {
            this.children.removeAll();
            this.add.text(GW/2, 80, "ВЫБЕРИТЕ ГЕРОЯ", { fontSize: '42px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            ["Воин", "Маг", "Лучник", "Ассасин"].forEach((name, i) => {
                let x = 300 * i + 150;
                let card = this.add.rectangle(x, 450, 260, 600, 0x1a1a1a).setInteractive().setStrokeStyle(2, 0xb48c46);
                this.add.image(x, 400, `hero_${name}`).setDisplaySize(200, 200);
                this.add.text(x, 620, name, { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
                card.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            const hps = { "Воин": 350, "Маг": 180, "Лучник": 220, "Ассасин": 200 };
            this.player = {
                job, maxHp: hps[job], hp: hps[job], arm: 0, mana: 0, gold: 0, level: 1, baseAtk: 30,
                equip: {
                    head: { s: 0, type: 'ARM' },
                    body: { s: 10, type: 'ARM' },
                    legs: { s: 0, type: 'ARM' },
                    weapon: { s: 10, type: 'ATK' },
                    ring: { s: 0, type: 'ATK' },
                    neck: { s: 0, type: 'DODGE' }
                }
            };
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.updateUI();
        }

        spawnMob() {
            let lvl = this.player.level;
            this.mob = { name: "Монстр Ур." + lvl, maxHp: 150 + (lvl*50), hp: 150 + (lvl*50), atk: 15 + (lvl*5) };
            this.turn = "PLAYER";
        }

        initGrid() {
            this.grid = []; this.isAnimating = false;
            for (let r=0; r<8; r++) {
                this.grid[r] = [];
                for (let c=0; c<8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let tile = this.add.image(OFFSET_X + c*66, OFFSET_Y + r*66, `tile_${type}`).setDisplaySize(62, 62).setInteractive();
            tile.gridR = r; tile.gridC = c; tile.type = type;
            tile.on('pointerdown', () => this.handleTileClick(tile));
            this.grid[r][c] = tile;
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.turn !== "PLAYER") return;
            if (!this.selectedTile) { this.selectedTile = tile; tile.setTint(0xffff00); }
            else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR), dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    if (!await this.checkMatches()) await this.swapTiles(this.selectedTile, tile);
                    else { 
                        this.turn = "MOB"; 
                        this.time.delayedCall(600, () => this.mobTurn()); 
                    }
                }
                if(this.selectedTile) this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: OFFSET_X+c2*66, y: OFFSET_Y+r2*66, duration: 200 });
                this.tweens.add({ targets: t2, x: OFFSET_X+c1*66, y: OFFSET_Y+r1*66, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        async mobTurn() {
            if (this.mob.hp <= 0) return;
            
            let dodgeChance = this.player.equip.neck.s;
            if (Math.random() * 100 < dodgeChance) {
                let t = this.add.text(GW/2, GH/2, "УКЛОНЕНИЕ!", { fontSize: '64px', fill: '#ffff00', fontStyle: 'bold' }).setOrigin(0.5);
                this.time.delayedCall(1000, () => t.destroy());
            } else {
                let damage = this.mob.atk;
                if (this.player.arm > 0) {
                    let absorbed = Math.min(this.player.arm, damage);
                    this.player.arm -= absorbed;
                    damage -= absorbed;
                }
                this.player.hp -= damage;
            }

            this.turn = "PLAYER";
            // Броня восстанавливается от шмота в начале твоего хода
            this.player.arm = this.player.equip.head.s + this.player.equip.body.s + this.player.equip.legs.s;
            this.updateUI();
        }

        async checkMatches() {
            let toRem = new Set();
            for(let r=0; r<8; r++) for(let c=0; c<6; c++) 
                if(this.grid[r][c].type===this.grid[r][c+1].type && this.grid[r][c].type===this.grid[r][c+2].type) 
                { toRem.add(this.grid[r][c]); toRem.add(this.grid[r][c+1]); toRem.add(this.grid[r][c+2]); }
            for(let c=0; c<8; c++) for(let r=0; r<6; r++)
                if(this.grid[r][c].type===this.grid[r+1][c].type && this.grid[r][c].type===this.grid[r+2][c].type)
                { toRem.add(this.grid[r][c]); toRem.add(this.grid[r+1][c]); toRem.add(this.grid[r+2][c]); }
            
            if (toRem.size > 0) {
                toRem.forEach(t => { this.applyEffect(t.type); t.destroy(); this.grid[t.gridR][t.gridC] = null; });
                await this.fillEmpty();
                await this.checkMatches();
                return true;
            }
            return false;
        }

        applyEffect(type) {
            let totalAtk = this.player.baseAtk + this.player.equip.weapon.s + this.player.equip.ring.s;
            if (type==='Red' || type==='Purple') this.mob.hp -= totalAtk/4;
            if (type==='Green') this.player.hp = Math.min(this.player.maxHp, this.player.hp + 10);
            if (type==='Blue') this.player.mana = Math.min(100, this.player.mana + 10);
            if (type==='Yellow') this.player.gold += 10;
            this.updateUI();
        }

        async fillEmpty() {
            for(let c=0; c<8; c++) for(let r=7; r>=0; r--) if(!this.grid[r][c]) {
                for(let k=r-1; k>=0; k--) if(this.grid[k][c]) {
                    this.grid[r][c]=this.grid[k][c]; this.grid[k][c]=null; this.grid[r][c].gridR=r; break;
                }
            }
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(!this.grid[r][c]) this.spawnTile(r, c);
            this.grid.flat().forEach(t => this.tweens.add({targets:t, x:OFFSET_X+t.gridC*66, y:OFFSET_Y+t.gridR*66, duration:200}));
            await new Promise(res => this.time.delayedCall(200, res));
        }

        createUI() {
            this.add.rectangle(175, 450, 310, 860, 0x191614).setStrokeStyle(2, 0xb48c46);
            this.add.image(175, 120, `hero_${this.player.job}`).setDisplaySize(130, 130);
            
            this.hpBar = this.add.graphics();
            this.armBar = this.add.graphics();
            this.hpText = this.add.text(40, 200, "", { fontSize: '18px', fill: '#ff4444', fontStyle: 'bold' });
            
            this.manaBar = this.add.graphics();
            this.manaText = this.add.text(40, 245, "", { fontSize: '18px', fill: '#4444ff' });
            
            this.goldText = this.add.text(40, 285, "", { fontSize: '20px', fill: '#ffd700', fontStyle: 'bold' });
            this.totalAtkText = this.add.text(40, 320, "", { fontSize: '20px', fill: '#ff4444', fontStyle: 'bold' });

            this.ultBtn = this.add.rectangle(175, 370, 200, 45, 0x330033).setInteractive().setStrokeStyle(2, 0xaa00aa);
            this.add.text(175, 370, "УЛЬТА [S]", { fontSize: '16px' }).setOrigin(0.5);
            this.ultBtn.on('pointerdown', () => this.useUlt());

            this.add.text(40, 410, "ИНВЕНТАРЬ:", { fontSize: '18px', fill: '#ffd700', fontStyle: 'bold' });
            const slots = ['head', 'body', 'legs', 'weapon', 'ring', 'neck'];
            this.equipLines = {};
            slots.forEach((s, i) => {
                this.equipLines[s] = this.add.text(40, 440 + (i * 25), "", { fontSize: '16px', fill: '#ffffff' });
            });

            this.mobIcon = this.add.image(1050, 150, 'mob_icon').setDisplaySize(140, 140).setFlipX(true);
            this.mobHpText = this.add.text(950, 240, "", { fontSize: '22px', fill: '#ff0000', align: 'center' });
            this.mobHpBar = this.add.graphics();
        }

        updateUI() {
            let maxArmorFromGear = this.player.equip.head.s + this.player.equip.body.s + this.player.equip.legs.s;
            
            // Отрисовка HP
            this.hpText.setText(`ЖИЗНЬ: ${Math.floor(this.player.hp)} / ${this.player.maxHp}\nБРОНЯ: ${this.player.arm}`);
            this.hpBar.clear().fillStyle(0x440000).fillRect(40, 225, 270, 15).fillStyle(0xff0000).fillRect(40, 225, (this.player.hp/this.player.maxHp)*270, 15);
            
            // Отрисовка Брони поверх HP (голубая полоска)
            if(maxArmorFromGear > 0) {
                this.armBar.clear().fillStyle(0x00ffff).fillRect(40, 225, (this.player.arm/maxArmorFromGear)*270, 5);
            }

            this.manaText.setText(`МАНА: ${this.player.mana}%`);
            this.manaBar.clear().fillStyle(0x000044).fillRect(40, 265, 270, 10).fillStyle(0x4444ff).fillRect(40, 265, (this.player.mana/100)*270, 10);
            
            this.goldText.setText(`ЗОЛОТО: ${this.player.gold}`);
            let totalAtk = this.player.baseAtk + this.player.equip.weapon.s + this.player.equip.ring.s;
            this.totalAtkText.setText(`УРОН ЗА ХОД: ${totalAtk}`);

            const loc = { head: "Голова", body: "Тело", legs: "Ноги", weapon: "Оружие", ring: "Кольцо", neck: "Амулет" };
            const typeText = { ARM: "БРОНЯ", ATK: "УРОН", DODGE: "ЛОВКОСТЬ" };
            
            for(let key in this.equipLines) {
                let item = this.player.equip[key];
                this.equipLines[key].setText(`${loc[key]}: +${item.s} ${typeText[item.type]}`);
            }

            this.mobHpText.setText(`${this.mob.name}\nHP: ${Math.floor(this.mob.hp)}/${this.mob.maxHp}`);
            this.mobHpBar.clear().fillStyle(0x440000).fillRect(950, 300, 210, 15).fillStyle(0xff0000).fillRect(950, 300, (Math.max(0, this.mob.hp)/this.mob.maxHp)*210, 15);
            
            if (this.mob.hp <= 0 && this.turn !== "LOOT") this.showLoot();
            if (this.player.hp <= 0) location.reload();
        }

        useUlt() {
            if (this.player.mana < 100) return;
            this.player.mana = 0;
            this.grid.flat().forEach(t => { if(t.type==='Red'||t.type==='Purple') this.applyEffect(t.type); });
            this.checkMatches(); this.updateUI();
        }

        showLoot() {
            this.turn = "LOOT";
            const slots = ['head', 'body', 'legs', 'weapon', 'ring', 'neck'];
            const names = { head: "Шлем", body: "Доспех", legs: "Поножи", weapon: "Оружие", ring: "Кольцо", neck: "Амулет" };
            const types = { head: 'ARM', body: 'ARM', legs: 'ARM', weapon: 'ATK', ring: 'ATK', neck: 'DODGE' };
            const typeNames = { ARM: "БРОНИ", ATK: "УРОНА", DODGE: "ЛОВКОСТИ" };
            
            let slot = Phaser.Utils.Array.GetRandom(slots);
            let statVal = 5 + (this.player.level * 5);
            let newItem = { slot: slot, n: names[slot], s: statVal, type: types[slot], price: 50 + (this.player.level * 25) };
            let oldItem = this.player.equip[slot];

            let overlay = this.add.container(GW/2, GH/2).setDepth(9999);
            let bg = this.add.rectangle(0, 0, 550, 450, 0x000000).setAlpha(0.95).setStrokeStyle(4, 0xffd700).setInteractive();
            
            let title = this.add.text(0, -150, "ПОБЕДА!", { fontSize: '42px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            let desc = this.add.text(0, -20, 
                `НАЙДЕНО: ${newItem.n}\nБонус: +${newItem.s} ${typeNames[newItem.type]}\n\n` +
                `СЕЙЧАС ОДЕТО: +${oldItem.s}\n\n` +
                `ЦЕНА ПРОДАЖИ: ${newItem.price} золота`, 
                { fontSize: '24px', align: 'center', fill: '#ffffff' }).setOrigin(0.5);

            let btnEquip = this.add.rectangle(-130, 150, 220, 70, 0x228B22).setInteractive().setStrokeStyle(2, 0xffffff);
            this.add.text(-130, 150, "ОДЕТЬ", { fontSize: '28px', fill: '#fff', fontStyle: 'bold' }).setOrigin(0.5);

            let btnSell = this.add.rectangle(130, 150, 220, 70, 0xB22222).setInteractive().setStrokeStyle(2, 0xffffff);
            this.add.text(130, 150, "ПРОДАТЬ", { fontSize: '28px', fill: '#fff', fontStyle: 'bold' }).setOrigin(0.5);

            overlay.add([bg, title, desc, btnEquip, btnSell]);

            btnEquip.on('pointerdown', () => {
                this.player.equip[newItem.slot] = { s: newItem.s, type: newItem.type };
                this.player.arm = this.player.equip.head.s + this.player.equip.body.s + this.player.equip.legs.s;
                this.nextLevel(overlay);
            });
            btnSell.on('pointerdown', () => {
                this.player.gold += newItem.price;
                this.nextLevel(overlay);
            });
        }

        nextLevel(overlay) {
            overlay.destroy();
            this.player.level++;
            this.spawnMob();
            this.updateUI();
        }
    }

    new Phaser.Game({ type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, scene: [MainScene] });
    </script>
</body>
</html>
