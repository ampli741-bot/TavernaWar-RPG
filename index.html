<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Match-3 RPG: Gold & Skills</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 2px solid #b48c46; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    // --- КОНФИГУРАЦИЯ И ПАРАМЕТРЫ ---
    const GW = 1200, GH = 900;
    const TILE_SIZE = 62, SPACING = 4;
    const OFFSET_X = 400, OFFSET_Y = 150;

    const COLORS_DATA = {
        "Red":    { symbol: "ATK", desc: "Урон" },
        "Blue":   { symbol: "MP",  desc: "Мана" },
        "Green":  { symbol: "HP",  desc: "Лечение" },
        "Purple": { symbol: "MAG", desc: "Маг. урон" },
        "Yellow": { symbol: "GOLD", desc: "Золото" }
    };

    const RARITY_COLORS = {
        "Обычное": "#c8c8c8", "Редкое": "#1e90ff",
        "Эпическое": "#a335ee", "Легендарное": "#ff8000"
    };

    // --- ЛОГИКА ИГРЫ ---
    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            // Загрузка графики (используем твои ассеты из репозитория)
            this.load.image('hero_Воин', 'assets/hero_warrior.png');
            this.load.image('hero_Маг', 'assets/hero_mage.png');
            this.load.image('hero_Лучник', 'assets/archer.png');
            this.load.image('hero_Ассасин', 'assets/assasin.png');
            this.load.image('mob_icon', 'assets/hero_warrior.png');
            
            this.load.image('tile_Red', 'assets/rune_red.png');
            this.load.image('tile_Blue', 'assets/rune_blue.png');
            this.load.image('tile_Green', 'assets/rune_green.png');
            this.load.image('tile_Purple', 'assets/rune_purple.png');
            this.load.image('tile_Yellow', 'assets/rune_yellow.png');
        }

        create() {
            this.state = "MENU";
            this.showMenu();
        }

        showMenu() {
            this.add.text(GW/2, 100, "ВЫБЕРИТЕ ГЕРОЯ", { fontSize: '48px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            const jobs = ["Воин", "Маг", "Лучник", "Ассасин"];
            jobs.forEach((name, i) => {
                let x = 300 * i + 150, y = 450;
                let bg = this.add.rectangle(x, y, 260, 500, 0x191614).setInteractive().setStrokeStyle(2, 0xb48c46);
                let img = this.add.image(x, y - 50, `hero_${name}`).setDisplaySize(180, 180);
                this.add.text(x, y + 150, name, { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
                
                bg.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            this.initPlayer(job);
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.state = "PLAYING";
        }

        initPlayer(job) {
            const stats = {
                "Воин":   { hp: 300, atk: 25, skill: "Ярость: Взрыв Крови" },
                "Маг":    { hp: 150, atk: 45, skill: "Инферно: Фиолетовый шторм" },
                "Лучник": { hp: 180, atk: 35, skill: "Снайпер: Сквозной выстрел" },
                "Ассасин":{ hp: 160, atk: 42, skill: "Тень: Веер клинков" }
            };
            let d = stats[job];
            this.player = {
                job, maxHp: d.hp, hp: d.hp, atk: d.atk, skillName: d.skill,
                level: 1, exp: 0, mana: 0, gold: 0,
                equipment: { 
                    "Шлем": null, "Грудь": null, "Перчатки": null, "Ноги": null,
                    "Оружие": { name: "Старый меч", stat: 10, type: "Оружие", rarity: "Обычное", desc: "Урон: +10", price: 0 }
                }
            };
        }

        getAtk() { return this.player.atk + (this.player.equipment["Оружие"] ? this.player.equipment["Оружие"].stat : 0); }
        getDef() { 
            let d = 0;
            for(let slot in this.player.equipment) if(slot !== "Оружие" && this.player.equipment[slot]) d += this.player.equipment[slot].stat;
            return d;
        }

        spawnMob() {
            let lvl = this.player.level;
            this.mob = {
                name: Phaser.Utils.Array.GetRandom(["Орк-Тиран", "Древний Лич", "Падший Рыцарь"]),
                hp: 150 * lvl, maxHp: 150 * lvl, atk: 18 * lvl
            };
            this.turn = "PLAYER";
        }

        initGrid() {
            this.grid = [];
            this.selectedTile = null;
            this.isAnimating = false;
            for (let r = 0; r < 8; r++) {
                this.grid[r] = [];
                for (let c = 0; c < 8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c) {
            const types = Object.keys(COLORS_DATA);
            let type = Phaser.Utils.Array.GetRandom(types);
            let x = OFFSET_X + c * (TILE_SIZE + SPACING);
            let y = OFFSET_Y + r * (TILE_SIZE + SPACING);
            let img = this.add.image(x, y, `tile_${type}`).setDisplaySize(TILE_SIZE, TILE_SIZE).setInteractive();
            img.gridR = r; img.gridC = c; img.type = type;
            img.on('pointerdown', () => this.handleTileClick(img));
            this.grid[r][c] = img;
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.turn !== "PLAYER") return;
            if (!this.selectedTile) {
                this.selectedTile = tile;
                tile.setTint(0xffff00);
            } else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR);
                let dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    if (!await this.checkMatches()) {
                        await this.swapTiles(this.selectedTile, tile);
                    } else {
                        this.turn = "MOB";
                        this.updateUI();
                        this.time.delayedCall(600, () => this.mobMove());
                    }
                }
                this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        swapTiles(t1, t2) {
            return new Promise(resolve => {
                this.isAnimating = true;
                let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
                this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
                t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
                this.tweens.add({
                    targets: t1, x: OFFSET_X + c2*(TILE_SIZE+SPACING), y: OFFSET_Y + r2*(TILE_SIZE+SPACING), duration: 200
                });
                this.tweens.add({
                    targets: t2, x: OFFSET_X + c1*(TILE_SIZE+SPACING), y: OFFSET_Y + r1*(TILE_SIZE+SPACING), duration: 200,
                    onComplete: () => { this.isAnimating = false; resolve(); }
                });
            });
        }

        async checkMatches() {
            let toRemove = new Set();
            // Горизонтальные
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 6; c++) {
                    if (this.grid[r][c].type === this.grid[r][c+1].type && this.grid[r][c].type === this.grid[r][c+2].type) {
                        toRemove.add(this.grid[r][c]); toRemove.add(this.grid[r][c+1]); toRemove.add(this.grid[r][c+2]);
                    }
                }
            }
            // Вертикальные
            for (let c = 0; c < 8; c++) {
                for (let r = 0; r < 6; r++) {
                    if (this.grid[r][c].type === this.grid[r+1][c].type && this.grid[r][c].type === this.grid[r+2][c].type) {
                        toRemove.add(this.grid[r][c]); toRemove.add(this.grid[r+1][c]); toRemove.add(this.grid[r+2][c]);
                    }
                }
            }

            if (toRemove.size > 0) {
                toRemove.forEach(t => {
                    this.applyEffect(t.type);
                    this.grid[t.gridR][t.gridC] = null;
                    t.destroy();
                });
                await this.fillEmpty();
                await this.checkMatches();
                return true;
            }
            return false;
        }

        applyEffect(type) {
            if (this.turn === "PLAYER") {
                if (type === "Red") this.mob.hp -= Math.floor(this.getAtk() / 4);
                else if (type === "Purple") this.mob.hp -= Math.floor(this.getAtk() / 2);
                else if (type === "Green") this.player.hp = Math.min(this.player.maxHp, this.player.hp + 15);
                else if (type === "Blue") this.player.mana = Math.min(100, this.player.mana + 15);
                else if (type === "Yellow") this.player.gold += Phaser.Math.Between(5, 15);
            }
            this.updateUI();
        }

        async fillEmpty() {
            for (let c = 0; c < 8; c++) {
                for (let r = 7; r >= 0; r--) {
                    if (!this.grid[r][c]) {
                        for (let k = r - 1; k >= 0; k--) {
                            if (this.grid[k][c]) {
                                this.grid[r][c] = this.grid[k][c];
                                this.grid[k][c] = null;
                                this.grid[r][c].gridR = r;
                                break;
                            }
                        }
                    }
                }
            }
            for (let c = 0; c < 8; c++) {
                for (let r = 0; r < 8; r++) {
                    if (!this.grid[r][c]) this.spawnTile(r, c);
                }
            }
            // Анимация падения
            return new Promise(resolve => {
                this.grid.flat().forEach(t => {
                    this.tweens.add({
                        targets: t, x: OFFSET_X + t.gridC*(TILE_SIZE+SPACING), y: OFFSET_Y + t.gridR*(TILE_SIZE+SPACING), duration: 200
                    });
                });
                this.time.delayedCall(250, resolve);
            });
        }

        mobMove() {
            if (this.mob.hp <= 0) return this.victory();
            let damage = Math.max(5, this.mob.atk - Math.floor(this.getDef() / 2));
            this.player.hp -= damage;
            this.turn = "PLAYER";
            this.updateUI();
            if (this.player.hp <= 0) location.reload();
        }

        victory() {
            this.player.exp += 50;
            if (this.player.exp >= 100) {
                this.player.level++;
                this.player.exp = 0;
                this.player.maxHp += 20;
                this.player.hp = this.player.maxHp;
            }
            this.showLoot();
        }

        showLoot() {
            const rarities = ["Обычное", "Редкое", "Эпическое", "Легендарное"];
            const weights = [60, 25, 10, 5];
            const rarity = rarities[this.weightedRandom(weights)];
            const types = ["Оружие", "Шлем", "Грудь", "Перчатки", "Ноги"];
            const type = Phaser.Utils.Array.GetRandom(types);
            const stat = Math.floor(10 * this.player.level * (rarity === "Легендарное" ? 2.0 : 1.2));
            
            const item = { name: `${rarity} ${type}`, type, stat, rarity, desc: `Бонус: +${stat}`, price: 50 };

            let overlay = this.add.container(GW/2, GH/2).setDepth(1000);
            let bg = this.add.rectangle(0, 0, 400, 400, 0x191614, 0.95).setStrokeStyle(4, 0xffd700);
            let title = this.add.text(0, -150, "ТРОФЕЙ!", { fontSize: '32px', fill: '#ffd700' }).setOrigin(0.5);
            let nameTxt = this.add.text(0, -50, item.name, { fontSize: '24px', fill: RARITY_COLORS[item.rarity] }).setOrigin(0.5);
            let descTxt = this.add.text(0, 20, item.desc, { fontSize: '28px', fill: '#50ff50' }).setOrigin(0.5);
            
            let btnY = this.add.rectangle(-100, 120, 150, 50, 0x282).setInteractive();
            this.add.text(-100, 120, "ВЗЯТЬ (Y)", { fontSize: '20px' }).setOrigin(0.5).setParentContainer(overlay);
            
            let btnN = this.add.rectangle(100, 120, 150, 50, 0x822).setInteractive();
            this.add.text(100, 120, "ВЫБРОС (N)", { fontSize: '20px' }).setOrigin(0.5).setParentContainer(overlay);

            overlay.add([bg, title, nameTxt, descTxt, btnY, btnN]);

            btnY.on('pointerdown', () => { 
                this.player.equipment[item.type] = item; 
                overlay.destroy(); 
                this.spawnMob(); 
                this.updateUI(); 
            });
            btnN.on('pointerdown', () => { overlay.destroy(); this.spawnMob(); this.updateUI(); });
        }

        weightedRandom(weights) {
            let sum = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * sum;
            for (let i = 0; i < weights.length; i++) {
                if (r < weights[i]) return i;
                r -= weights[i];
            }
        }

        createUI() {
            // Панель героя
            this.add.rectangle(175, 450, 310, 860, 0x191614).setStrokeStyle(2, 0xb48c46);
            this.avatar = this.add.image(175, 150, `hero_${this.player.job}`).setDisplaySize(150, 150);
            this.nameTxt = this.add.text(40, 250, "", { fontSize: '24px', fontStyle: 'bold' });
            this.goldTxt = this.add.text(40, 280, "", { fontSize: '18px', fill: '#ffd700' });
            
            // Полоски
            this.hpBar = this.add.graphics();
            this.manaBar = this.add.graphics();
            this.manaLabel = this.add.text(40, 350, "МАНА: 0/100 [S] УЛЬТА", { fontSize: '14px' });

            // Экипировка
            this.equipTxts = [];
            const slots = ["Оружие", "Шлем", "Грудь", "Перчатки", "Ноги"];
            slots.forEach((s, i) => {
                this.equipTxts.push(this.add.text(40, 450 + i * 70, "", { fontSize: '14px' }));
            });

            // Моб
            this.mobPanel = this.add.container(920, 20);
            this.mobPanel.add(this.add.rectangle(130, 75, 260, 150, 0x191614, 0.8).setStrokeStyle(2, 0xb48c46));
            this.mobNameTxt = this.add.text(20, 20, "", { fontSize: '24px', fill: '#ff6464' });
            this.mobHpBar = this.add.graphics();
            this.mobPanel.add([this.mobNameTxt, this.mobHpBar]);

            // Кнопка Ульты для ПК
            this.input.keyboard.on('keydown-S', () => this.useUltimate());
        }

        updateUI() {
            this.nameTxt.setText(`${this.player.job} LVL ${this.player.level}`);
            this.goldTxt.setText(`Золото: ${this.player.gold}`);
            
            // Отрисовка HP
            this.hpBar.clear();
            this.hpBar.fillStyle(0x3c0000).fillRect(40, 310, 270, 20);
            this.hpBar.fillStyle(0xdc2828).fillRect(40, 310, (this.player.hp/this.player.maxHp)*270, 20);
            
            // Отрисовка Маны
            this.manaBar.clear();
            this.manaBar.fillStyle(0x141464).fillRect(40, 335, 270, 10);
            this.manaBar.fillStyle(0x2878ff).fillRect(40, 335, (this.player.mana/100)*270, 10);
            this.manaLabel.setText(`МАНА: ${this.player.mana}/100 [S] УЛЬТА`);

            // Моб UI
            this.mobNameTxt.setText(this.mob.name);
            this.mobHpBar.clear();
            this.mobHpBar.fillStyle(0xc82828).fillRect(20, 60, (Math.max(0, this.mob.hp)/this.mob.maxHp)*220, 15);

            // Инвентарь
            const slots = ["Оружие", "Шлем", "Грудь", "Перчатки", "Ноги"];
            slots.forEach((s, i) => {
                let item = this.player.equipment[s];
                let col = item ? RARITY_COLORS[item.rarity] : "#646464";
                this.equipTxts[i].setText(`${s}: ${item ? item.name : '--'}\n${item ? item.desc : ''}`).setTint(Phaser.Display.Color.HexStringToColor(col).color);
            });
        }

        useUltimate() {
            if (this.player.mana < 100 || this.isAnimating) return;
            this.player.mana = 0;
            const job = this.player.job;
            
            if (job === "Воин") {
                this.grid.flat().forEach(t => { if(t.type === "Red") this.applyEffect(t.type); });
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + 50);
            } else if (job === "Маг") {
                for(let i=0; i<12; i++) this.applyEffect("Purple");
            } else if (job === "Лучник") {
                let r = Phaser.Math.Between(0, 7), c = Phaser.Math.Between(0, 7);
                for(let i=0; i<8; i++) { this.applyEffect(this.grid[r][i].type); this.applyEffect(this.grid[i][c].type); }
            } else if (job === "Ассасин") {
                for(let i=0; i<9; i++) this.applyEffect(Phaser.Utils.Array.GetRandom(["Red", "Purple"]));
            }
            this.checkMatches();
            this.updateUI();
        }
    }

    const config = {
        type: Phaser.AUTO,
        parent: 'game-container',
        width: GW, height: GH,
        backgroundColor: '#0c0a08',
        scene: [MainScene]
    };

    const game = new Phaser.Game(config);
    </script>
</body>
</html>
