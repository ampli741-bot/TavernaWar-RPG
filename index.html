<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Gothic Perfection</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Quicksand:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        :root { 
            --gold: #ffd700; --bg: #0c0a08;
            --font-main: 'Quicksand', sans-serif;
            --font-gothic: 'Cinzel', serif;
            --hp-grad: linear-gradient(90deg, #8b0000, #ff4444);
            --mn-grad: linear-gradient(90deg, #004488, #3399ff);
            --ar-grad: linear-gradient(90deg, #333333, #5dade2);
        }

        body { 
            margin: 0; background: var(--bg) url('assets/bg.jpg') center/cover; color: white; 
            display: grid; grid-template-columns: 380px 1fr 380px; height: 100vh; overflow: hidden; 
            font-family: var(--font-main); touch-action: none; 
        }

        #ui-left, #ui-right { 
            width: 380px; padding: 20px; display: flex; flex-direction: column; 
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-left: 4px solid #333; border-right: 4px solid #111; z-index: 10;
        }

        #game-container { display: flex; justify-content: center; align-items: center; z-index: 5; }

        .portrait { 
            width: 200px; height: 200px; margin: 0 auto 10px; border: 6px solid #222; 
            border-radius: 10px; background-size: cover; background-position: center;
        }

        .bar-bg { 
            width: 100%; height: 22px; background: #000; border: 1px solid #333; margin-top: 5px; 
            position: relative; clip-path: polygon(2% 0%, 98% 0%, 100% 50%, 98% 100%, 2% 100%, 0% 50%);
        }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 11px; line-height: 22px; font-weight: 700; z-index: 5; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s ease; }

        #p-hp-f, #m-hp-f { background: var(--hp-grad); }
        #p-mn-f { background: var(--mn-grad); }
        #p-arm-f { background: var(--ar-grad); }

        .btn-ultra { 
            width: 100%; margin-top: 10px; padding: 12px; font-family: var(--font-gothic);
            background: #222; color: #555; border: 2px solid #333; cursor: not-allowed; 
        }
        .btn-ultra.ready { background: linear-gradient(180deg, #800, #400); color: white; border-color: #f00; cursor: pointer; }

        #battle-log { height: 150px; margin-top: 15px; background: rgba(0,0,0,0.5); padding: 10px; font-size: 12px; overflow-y: auto; border: 1px solid #222; }

        /* –ú–ï–ù–Æ */
        #menu-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; 
        }
        .hero-cards { display: grid; grid-template-columns: repeat(2, 260px); gap: 20px; }
        .hero-card { 
            width: 240px; height: 240px; border: 4px solid #333; border-radius: 50%; 
            background-size: cover; cursor: pointer; transition: 0.3s; position: relative;
        }
        .hero-card:hover { border-color: var(--gold); transform: scale(1.05); }
        .hero-card h3 { position: absolute; bottom: 20px; width: 100%; text-align: center; color: var(--gold); font-family: var(--font-gothic); margin:0; }
    </style>
</head>
<body>

    <div id="menu-overlay">
        <h1 style="color:var(--gold); font-family: var(--font-gothic); font-size: 40px; margin-bottom: 30px;">TAVERNA WAR</h1>
        <div class="hero-cards">
            <div class="hero-card" style="background-image: url('assets/hero_warrior.jpg');" onclick="startGame('warrior')"><h3>–í–û–ò–ù</h3></div>
            <div class="hero-card" style="background-image: url('assets/hero_mage.jpg');" onclick="startGame('mage')"><h3>–ú–ê–ì</h3></div>
            <div class="hero-card" style="background-image: url('assets/hero_archer.jpg');" onclick="startGame('archer')"><h3>–õ–£–ß–ù–ò–ö</h3></div>
            <div class="hero-card" style="background-image: url('assets/hero_assasin.jpg');" onclick="startGame('assassin')"><h3>–£–ë–ò–ô–¶–ê</h3></div>
        </div>
    </div>

    <div id="ui-left">
        <div id="p-portrait" class="portrait"></div>
        <div class="bar-bg"><div id="p-arm-t" class="bar-text">–ë–†–û–ù–Ø: 50</div><div id="p-arm-f" class="bar-fill" style="width:50%"></div></div>
        <div class="bar-bg"><div id="p-hp-t" class="bar-text">1000 / 1000</div><div id="p-hp-f" class="bar-fill"></div></div>
        <div class="bar-bg"><div id="p-mn-t" class="bar-text">–ú–ê–ù–ê: 0%</div><div id="p-mn-f" class="bar-fill" style="width:0%"></div></div>
        <button id="btn-ultra" class="btn-ultra" onclick="useUltra()">–°–£–ü–ï–†–£–î–ê–†</button>
        <div style="margin-top:20px;">–£—Ä–æ–Ω: <b id="stat-atk" style="color:red">30</b></div>
        <div>–ó–æ–ª–æ—Ç–æ: <b id="gold-val" style="color:var(--gold)">0 üí∞</b></div>
    </div>

    <div id="game-container"></div>

    <div id="ui-right">
        <div id="m-portrait" class="portrait" style="background-image: url('assets/mob_goblin.jpg'); filter: sepia(0.4);"></div>
        <h2 style="text-align:center; color:red; font-family: var(--font-gothic);">–ì–†–£–ù–¢ –ì–û–†–ù–´–ô</h2>
        <div class="bar-bg"><div id="m-hp-t" class="bar-text">600 / 600</div><div id="m-hp-f" class="bar-fill"></div></div>
        <div id="battle-log"></div>
    </div>

    <script>
        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (–°–ö–ï–õ–ï–¢) ---
        const TILE_SIZE = 80;
        const GRID_SIZE = 8;
        const TYPES = ['rune_red', 'rune_blue', 'rune_green', 'rune_purple', 'rune_yellow'];

        window.app = {
            player: { hp: 1000, maxHp: 1000, mana: 0, armor: 50, maxArmor: 100, atk: 30, gold: 0 },
            mob: { hp: 600, maxHp: 600, atk: 20 },
            log: (msg, color) => {
                const log = document.getElementById('battle-log');
                log.innerHTML = `<div style="color:${color}">> ${msg}</div>` + log.innerHTML;
            }
        };

        function updateUI() {
            const { player: p, mob: m } = window.app;
            document.getElementById('p-hp-f').style.width = (p.hp / p.maxHp * 100) + '%';
            document.getElementById('p-hp-t').innerText = `${Math.ceil(p.hp)} / ${p.maxHp}`;
            document.getElementById('p-mn-f').style.width = p.mana + '%';
            document.getElementById('p-mn-t').innerText = `–ú–ê–ù–ê: ${p.mana}%`;
            document.getElementById('m-hp-f').style.width = (m.hp / m.maxHp * 100) + '%';
            document.getElementById('m-hp-t').innerText = `${Math.ceil(m.hp)} / ${m.maxHp}`;
            document.getElementById('gold-val').innerText = p.gold + " üí∞";
            
            const btn = document.getElementById('btn-ultra');
            if (p.mana >= 100) btn.classList.add('ready');
            else btn.classList.remove('ready');
        }

        window.startGame = function(type) {
            document.getElementById('menu-overlay').style.display = 'none'; // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –°–ö–†–´–¢–ò–ï
            const img = type === 'assassin' ? 'hero_assasin.jpg' : `hero_${type}.jpg`;
            document.getElementById('p-portrait').style.backgroundImage = `url('assets/${img}')`;
            
            new Phaser.Game({
                type: Phaser.AUTO,
                parent: 'game-container',
                width: GRID_SIZE * TILE_SIZE,
                height: GRID_SIZE * TILE_SIZE,
                transparent: true,
                scene: { preload, create, extend: { spawnTile, handleSelect, swapTiles, checkMatches, handleMatches, dropTiles, mobTurn } }
            });
        };

        function preload() {
            TYPES.forEach(t => this.load.image(t, `assets/${t}.png`));
        }

        function create() {
            this.grid = [];
            this.isAnimating = false;
            for (let r = 0; r < GRID_SIZE; r++) {
                this.grid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) this.spawnTile(r, c);
            }
        }

        function spawnTile(r, c, fromTop = false) {
            const type = Phaser.Utils.Array.GetRandom(TYPES);
            const x = c * TILE_SIZE + TILE_SIZE / 2;
            const y = fromTop ? -TILE_SIZE : r * TILE_SIZE + TILE_SIZE / 2;
            const container = this.add.container(x, y);
            const img = this.add.image(0, 0, type).setDisplaySize(70, 70).setInteractive();
            container.add(img);
            container.type = type; container.gridR = r; container.gridC = c;
            img.on('pointerdown', () => this.handleSelect(container));
            this.grid[r][c] = container;
            if (fromTop) this.tweens.add({ targets: container, y: r * TILE_SIZE + TILE_SIZE / 2, duration: 300 });
        }

        async function handleSelect(tile) {
            if (this.isAnimating) return;
            if (!this.selectedTile) {
                this.selectedTile = tile; tile.setScale(1.1);
            } else {
                const dist = Math.abs(this.selectedTile.gridR - tile.gridR) + Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dist === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    const matches = this.checkMatches();
                    if (matches.length > 0) {
                        await this.handleMatches(matches);
                        this.time.delayedCall(500, () => this.mobTurn());
                    } else {
                        await this.swapTiles(this.selectedTile, tile);
                    }
                }
                this.selectedTile.setScale(1); this.selectedTile = null;
            }
        }

        async function swapTiles(t1, t2) {
            this.isAnimating = true;
            const r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: c2*TILE_SIZE+TILE_SIZE/2, y: r2*TILE_SIZE+TILE_SIZE/2, duration: 200 });
                this.tweens.add({ targets: t2, x: c1*TILE_SIZE+TILE_SIZE/2, y: r1*TILE_SIZE+TILE_SIZE/2, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        function checkMatches() {
            let matched = new Set();
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE - 2; c++) {
                    let t1 = this.grid[r][c], t2 = this.grid[r][c+1], t3 = this.grid[r][c+2];
                    if (t1 && t2 && t3 && t1.type === t2.type && t2.type === t3.type) { matched.add(t1); matched.add(t2); matched.add(t3); }
                }
            }
            for (let c = 0; c < GRID_SIZE; c++) {
                for (let r = 0; r < GRID_SIZE - 2; r++) {
                    let t1 = this.grid[r][c], t2 = this.grid[r+1][c], t3 = this.grid[r+2][c];
                    if (t1 && t2 && t3 && t1.type === t2.type && t2.type === t3.type) { matched.add(t1); matched.add(t2); matched.add(t3); }
                }
            }
            return Array.from(matched);
        }

        async function handleMatches(matches) {
            const p = window.app.player;
            matches.forEach(t => {
                if (t.type === 'rune_red') window.app.mob.hp -= p.atk;
                if (t.type === 'rune_blue') p.mana = Math.min(100, p.mana + 5);
                if (t.type === 'rune_green') p.hp = Math.min(p.maxHp, p.hp + 20);
                if (t.type === 'rune_yellow') p.gold += 10;
                this.grid[t.gridR][t.gridC] = null; t.destroy();
            });
            updateUI();
            await this.dropTiles();
            const next = this.checkMatches();
            if (next.length > 0) await this.handleMatches(next);
        }

        async function dropTiles() {
            for (let c = 0; c < GRID_SIZE; c++) {
                let empty = 0;
                for (let r = GRID_SIZE-1; r >= 0; r--) {
                    if (!this.grid[r][c]) empty++;
                    else if (empty > 0) {
                        let tile = this.grid[r][c]; this.grid[r+empty][c] = tile; this.grid[r][c] = null;
                        tile.gridR = r+empty; this.tweens.add({ targets: tile, y: tile.gridR*TILE_SIZE+TILE_SIZE/2, duration: 200 });
                    }
                }
                for (let i = 0; i < empty; i++) this.spawnTile(i, c, true);
            }
            await new Promise(res => this.time.delayedCall(300, res));
        }

        function mobTurn() {
            if (window.app.mob.hp <= 0) { window.app.log("–ü–û–ë–ï–î–ê!", "gold"); return; }
            window.app.player.hp -= window.app.mob.atk;
            window.app.log(`–í—Ä–∞–≥ –Ω–∞–Ω–µ—Å ${window.app.mob.atk} —É—Ä–æ–Ω–∞`, "red");
            updateUI();
        }

        window.useUltra = function() {
            if (window.app.player.mana < 100) return;
            window.app.player.mana = 0; window.app.mob.hp -= 200;
            window.app.log("–£–õ–¨–¢–†–ê–£–î–ê–†! -200 HP", "violet"); updateUI();
        };
    </script>
</body>
</html>
