<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Taverna War RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; color: white; font-family: sans-serif; }
        canvas { border: 2px solid #b48c46; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    // ==========================================
    // КОНСТАНТЫ И НАСТРОЙКИ
    // ==========================================
    const GW = 1200, GH = 900, OFFSET_X = 400, OFFSET_Y = 140, TILE_S = 68;

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        // ==========================================
        // 1. ЗАГРУЗКА РЕСУРСОВ
        // ==========================================
        preload() {
            // Спрайты героев (заглушки, если нет своих файлов)
            this.load.image('hero_Воин', 'https://labs.phaser.io/assets/sprites/knight.png');
            this.load.image('hero_Маг', 'https://labs.phaser.io/assets/sprites/wizard-idle.png');
            this.load.image('hero_Лучник', 'https://labs.phaser.io/assets/sprites/clown.png');
            this.load.image('hero_Ассасин', 'https://labs.phaser.io/assets/sprites/phaser-dude.png');
            this.load.image('mob_icon', 'https://labs.phaser.io/assets/sprites/monstermouth.png');
            
            // Тайлы (руны)
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => 
                this.load.image(`tile_${c}`, `https://labs.phaser.io/assets/particles/${c.toLowerCase()}_ball.png`)
            );
        }

        create() { this.showMenu(); }

        // ==========================================
        // 2. ЛОГИКА ПЕРСОНАЖЕЙ (ТВОЙ ЖЕСТКИЙ СКЕЛЕТ)
        // ==========================================
        initPlayerData(job) {
            const hps = { "Воин": 1400, "Маг": 720, "Лучник": 880, "Ассасин": 800 };
            this.player = {
                job, maxHp: hps[job], hp: hps[job], arm: 0, mana: 0, gold: 0, level: 1, baseAtk: 25,
                equip: {
                    head: { n: "Шлем", atk: 0, arm: 2 },
                    body: { n: "Броня", atk: 0, arm: 5 },
                    weapon: { n: "Меч", atk: 12, arm: 0 },
                    ring: { n: "Кольцо", atk: 2, arm: 0 }
                }
            };
            this.recalcStats();
        }

        recalcStats() {
            this.player.arm = Object.values(this.player.equip).reduce((a, b) => a + (b.arm || 0), 0);
        }

        spawnMob() {
            let lvl = this.player.level;
            this.mob = { 
                name: "Монстр Ур." + lvl, 
                maxHp: 100 + (lvl * 60), 
                hp: 100 + (lvl * 60), 
                atk: 15 + (lvl * 10)
            };
            this.turn = "PLAYER";
            this.lootActive = false;
        }

        // ==========================================
        // 3. СУПЕРУДАРЫ
        // ==========================================
        async useUlt() {
            if (this.player.mana < 100 || this.isAnimating) return;
            this.player.mana = 0;
            this.isAnimating = true;

            let targets = [];
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    let t = this.grid[r][c];
                    if (this.player.job === "Воин" && (t.type === 'Red' || t.type === 'Green')) targets.push(t);
                    if (this.player.job === "Маг" && (t.type === 'Purple' || t.type === 'Yellow')) targets.push(t);
                    if (this.player.job === "Лучник" && (t.type === 'Red' || t.type === 'Blue')) targets.push(t);
                    if (this.player.job === "Ассасин" && (c % 2 === 0)) targets.push(t);
                }
            }

            this.tweens.add({
                targets: targets,
                tintFill: true, tint: 0xffffff, duration: 400,
                onComplete: () => {
                    targets.forEach(t => {
                        this.applyEffect(t.type, 1.5);
                        this.grid[t.gridR][t.gridC] = null;
                        t.destroy();
                    });
                    this.fillEmpty().then(() => {
                        this.isAnimating = false;
                        this.updateUI();
                        this.time.delayedCall(500, () => this.mobAI());
                    });
                }
            });
        }

        // ==========================================
        // 4. МЕХАНИКА ТРИ-В-РЯД (ВСПОМОГАТЕЛЬНЫЕ)
        // ==========================================
        initGrid() {
            this.grid = [];
            for (let r=0; r<8; r++) {
                this.grid[r] = [];
                for (let c=0; c<8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c, fromTop = false) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let tx = OFFSET_X + c * TILE_S, ty = OFFSET_Y + r * TILE_S;
            let tile = this.add.image(tx, fromTop ? ty - 500 : ty, `tile_${type}`).setDisplaySize(60, 60).setInteractive();
            tile.gridR = r; tile.gridC = c; tile.type = type;
            tile.on('pointerdown', () => this.handleTileClick(tile));
            this.grid[r][c] = tile;
            if (fromTop) this.tweens.add({ targets: tile, y: ty, duration: 400 });
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.turn !== "PLAYER" || this.lootActive) return;
            if (!this.selectedTile) {
                this.selectedTile = tile; tile.setTint(0xffff00);
            } else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR), dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    if (!await this.checkMatches()) await this.swapTiles(this.selectedTile, tile);
                    else { this.turn = "MOB"; this.time.delayedCall(600, () => this.mobAI()); }
                }
                if(this.selectedTile) this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            [this.grid[r1][c1], this.grid[r2][c2]] = [this.grid[r2][c2], this.grid[r1][c1]];
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: OFFSET_X+c2*TILE_S, y: OFFSET_Y+r2*TILE_S, duration: 200 });
                this.tweens.add({ targets: t2, x: OFFSET_X+c1*TILE_S, y: OFFSET_Y+r1*TILE_S, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        async checkMatches() {
            let matches = new Set();
            for(let r=0; r<8; r++) for(let c=0; c<6; c++) 
                if(this.grid[r][c] && this.grid[r][c+1] && this.grid[r][c+2] && 
                   this.grid[r][c].type === this.grid[r][c+1].type && this.grid[r][c].type === this.grid[r][c+2].type)
                   { matches.add(this.grid[r][c]); matches.add(this.grid[r][c+1]); matches.add(this.grid[r][c+2]); }
            
            for(let c=0; c<8; c++) for(let r=0; r<6; r++)
                if(this.grid[r][c] && this.grid[r+1][c] && this.grid[r+2][c] &&
                   this.grid[r][c].type === this.grid[r+1][c].type && this.grid[r][c].type === this.grid[r+2][c].type)
                   { matches.add(this.grid[r][c]); matches.add(this.grid[r+1][c]); matches.add(this.grid[r+2][c]); }

            if (matches.size > 0) {
                matches.forEach(t => {
                    this.turn === "PLAYER" ? this.applyEffect(t.type) : this.applyMobEffect(t.type);
                    this.grid[t.gridR][t.gridC] = null;
                    t.destroy();
                });
                await this.fillEmpty();
                await this.checkMatches();
                return true;
            }
            return false;
        }

        async fillEmpty() {
            for(let c=0; c<8; c++) {
                let empty = 0;
                for(let r=7; r>=0; r--) {
                    if(!this.grid[r][c]) empty++;
                    else if(empty > 0) {
                        let t = this.grid[r][c];
                        this.grid[r+empty][c] = t; this.grid[r][c] = null;
                        t.gridR = r+empty;
                        this.tweens.add({ targets: t, y: OFFSET_Y+t.gridR*TILE_S, duration: 300 });
                    }
                }
                for(let i=0; i<empty; i++) this.spawnTile(i, c, true);
            }
            return new Promise(res => this.time.delayedCall(400, res));
        }

        // ==========================================
        // 5. ИИ МОБА
        // ==========================================
        async mobAI() {
            if (this.mob.hp <= 0 || this.lootActive) return;
            // Имитация хода (упрощенно)
            await this.checkMatches();
            this.turn = "PLAYER";
            this.updateUI();
        }

        // ==========================================
        // 6. ИНТЕРФЕЙС И ЭФФЕКТЫ
        // ==========================================
        applyEffect(type, mult = 1) {
            let atk = (this.player.baseAtk + (this.player.equip.weapon.atk || 0)) * mult;
            if (type === 'Red' || type === 'Purple') this.mob.hp -= atk/4;
            if (type === 'Green') this.player.hp = Math.min(this.player.maxHp, this.player.hp + 20);
            if (type === 'Blue') this.player.mana = Math.min(100, this.player.mana + 15);
            if (type === 'Yellow') this.player.gold += 10;
            this.updateUI();
        }

        applyMobEffect(type) {
            let dmg = this.mob.atk;
            if(this.player.arm > 0) { this.player.arm -= dmg/2; dmg /= 2; }
            this.player.hp -= dmg;
            this.updateUI();
        }

        showMenu() {
            this.add.text(GW/2, 200, "TAVERNA WAR", { fontSize: '64px', fill: '#ffd700' }).setOrigin(0.5);
            ["Воин", "Маг", "Лучник", "Ассасин"].forEach((job, i) => {
                let btn = this.add.rectangle(200 + i*250, 500, 200, 300, 0x1a1a1a).setInteractive().setStrokeStyle(2, 0xffffff);
                this.add.text(200 + i*250, 500, job, { fontSize: '24px' }).setOrigin(0.5);
                btn.on('pointerdown', () => {
                    this.initPlayerData(job);
                    this.spawnMob();
                    this.children.removeAll();
                    this.initGrid();
                    this.createUI();
                    this.updateUI();
                });
            });
        }

        createUI() {
            this.add.rectangle(175, 450, 310, 860, 0x191614).setStrokeStyle(2, 0xb48c46);
            this.hpText = this.add.text(40, 250, "", { fontSize: '20px', fill: '#ff4444' });
            this.goldText = this.add.text(40, 350, "", { fontSize: '20px', fill: '#ffd700' });
            this.ultBtn = this.add.rectangle(175, 450, 240, 50, 0x330033).setInteractive();
            this.add.text(175, 450, "СУПЕРУДАР", { fontSize: '20px' }).setOrigin(0.5);
            this.ultBtn.on('pointerdown', () => this.useUlt());
            this.mobHpText = this.add.text(950, 250, "", { fontSize: '22px', fill: '#ff0000' });
        }

        updateUI() {
            this.hpText.setText(`HP: ${Math.floor(this.player.hp)}\nARMOR: ${Math.floor(this.player.arm)}\nMANA: ${this.player.mana}%`);
            this.goldText.setText(`GOLD: ${this.player.gold}\nLEVEL: ${this.player.level}`);
            this.mobHpText.setText(`${this.mob.name}\nHP: ${Math.floor(this.mob.hp)}`);
            if (this.mob.hp <= 0 && !this.lootActive) {
                this.lootActive = true;
                this.showLoot(this.generateLoot());
            }
        }

        // ==========================================
        // 7. СИСТЕМА ЛУТА
        // ==========================================
        generateLoot() {
            const rarities = [
                { n: 'Обычный', c: '#fff', m: 1 },
                { n: 'Редкий', c: '#0f0', m: 1.5 },
                { n: 'Легендарный', c: '#f80', m: 3 }
            ];
            let rarity = Phaser.Utils.Array.GetRandom(rarities);
            let item = Phaser.Utils.Array.GetRandom([
                {n: 'Шлем', s: 'head', st: 'arm'},
                {n: 'Меч', s: 'weapon', st: 'atk'}
            ]);
            return { ...item, val: Math.floor(this.player.level * 5 * rarity.m), rName: rarity.n, color: rarity.c };
        }

        showLoot(loot) {
            let box = this.add.container(GW/2, GH/2);
            let bg = this.add.rectangle(0, 0, 400, 300, 0x000, 0.9).setStrokeStyle(2, 0xfff);
            let txt = this.add.text(0, -50, `НАЙДЕНО:\n${loot.rName} ${loot.n}\n+${loot.val}`, { align: 'center', fill: loot.color }).setOrigin(0.5);
            let btn = this.add.rectangle(0, 80, 120, 40, 0x224422).setInteractive();
            this.add.text(0, 80, "ВЗЯТЬ").setOrigin(0.5).setParentContainer(box);
            box.add([bg, txt, btn]);
            btn.on('pointerdown', () => {
                this.player.equip[loot.s] = { n: loot.n, [loot.st]: loot.val };
                this.recalcStats();
                box.destroy();
                this.player.level++;
                this.spawnMob();
                this.updateUI();
            });
        }
    }

    const config = { type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, scene: MainScene };
    new Phaser.Game(config);
    </script>
</body>
</html>
