<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Taverna War - Rigid Skeleton</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #eee;
            font-family: 'Verdana', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-wrapper {
            position: relative;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* Панели UI */
        .ui-panel {
            width: 180px;
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }

        .hero-portrait {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
        }

        /* Полоски статов */
        .stat-container { text-align: center; }
        .bar-bg {
            width: 100%;
            height: 14px;
            background: #222;
            border: 1px solid #444;
            border-radius: 7px;
            overflow: hidden;
            margin: 4px 0;
        }
        .bar-fill { height: 100%; width: 100%; transition: 0.3s; }
        #hp-fill { background: linear-gradient(90deg, #8b0000, #ff4d4d); }
        #mp-fill { background: linear-gradient(90deg, #00008b, #4d4dff); }
        #mob-hp-fill { background: #ff4d4d; }

        /* Кнопки */
        .btn {
            background: #1a1a1a;
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .btn:hover { background: #ffd700; color: #000; }

        /* Оверлеи */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .char-select {
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .char-select:hover { transform: scale(1.05); }
        .char-select img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ffd700;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="ui-left" class="ui-panel hidden">
        <div id="hero-img" class="hero-portrait"></div>
        <div class="stat-container">
            <small>ЗДОРОВЬЕ</small>
            <div class="bar-bg"><div id="hp-fill" class="bar-fill"></div></div>
            <small>МАНА</small>
            <div class="bar-bg"><div id="mp-fill" class="bar-fill"></div></div>
        </div>
        <button class="btn" onclick="useAbility('strike')">Суперудар (40)</button>
        <button class="btn" onclick="useAbility('heal')">Лечение (30)</button>
    </div>

    <div id="game-container" style="width: 640px; height: 640px; background: #111; border-radius: 8px;"></div>

    <div id="ui-right" class="ui-panel hidden">
        <h3 style="text-align: center; color: #ff4d4d; margin: 0;">ВРАГ</h3>
        <div id="mob-img" class="hero-portrait" style="border-color: #ff4d4d;"></div>
        <div class="stat-container">
            <div class="bar-bg"><div id="mob-hp-fill" class="bar-fill"></div></div>
            <small id="mob-hp-text">100/100</small>
        </div>
        <div id="log" style="font-size: 11px; height: 150px; overflow-y: auto; color: #aaa; border-top: 1px solid #333; padding-top: 5px;"></div>
    </div>

    <div id="start-menu" class="overlay">
        <h1 style="color: #ffd700; letter-spacing: 5px;">TAVERNA WAR</h1>
        <div class="character-grid">
            <div class="char-select" onclick="initGame('WARRIOR')">
                <img src="https://via.placeholder.com/120/8b0000/ffffff?text=ВОИН">
                <p>ВОИН</p>
            </div>
            <div class="char-select" onclick="initGame('MAGE')">
                <img src="https://via.placeholder.com/120/00008b/ffffff?text=МАГ">
                <p>МАГ</p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ ---
    window.appState = {
        player: { hp: 100, maxHp: 100, mp: 0, atk: 12 },
        mob: { hp: 100, maxHp: 100, atk: 8 },
        turn: 'PLAYER'
    };

    function updateUI() {
        const { player: p, mob: m } = window.appState;
        document.getElementById('hp-fill').style.width = (p.hp / p.maxHp * 100) + '%';
        document.getElementById('mp-fill').style.width = p.mp + '%';
        document.getElementById('mob-hp-fill').style.width = (m.hp / m.maxHp * 100) + '%';
        document.getElementById('mob-hp-text').innerText = `${Math.ceil(m.hp)} / ${m.maxHp}`;
    }

    function addLog(msg, color = "#aaa") {
        const log = document.getElementById('log');
        log.innerHTML = `<div style="color: ${color}">${msg}</div>` + log.innerHTML;
    }

    // --- ЛОГИКА PHASER ---
    class GameScene extends Phaser.Scene {
        constructor() { super('GameScene'); }

        create() {
            window.gameScene = this;
            this.grid = [];
            this.canMove = true;
            this.selected = null;

            // Создаем сетку 8x8
            for (let r = 0; r < 8; r++) {
                this.grid[r] = [];
                for (let c = 0; c < 8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c) {
            const colors = [0xff4d4d, 0x4d4dff, 0x4dff4d, 0xffd700, 0x9933ff];
            const typeIdx = Math.floor(Math.random() * colors.length);
            
            const x = c * 80 + 40;
            const y = r * 80 + 40;

            const container = this.add.container(x, y);
            const rect = this.add.rectangle(0, 0, 70, 70, colors[typeIdx]).setInteractive();
            const glow = this.add.rectangle(0, 0, 74, 74, 0xffffff, 0.1).setVisible(false);
            
            container.add([glow, rect]);
            container.gridR = r; container.gridC = c; container.type = typeIdx;
            
            rect.on('pointerdown', () => this.handleSelect(container));
            this.grid[r][c] = container;
        }

        async handleSelect(tile) {
            if (!this.canMove || window.appState.turn !== 'PLAYER') return;

            if (!this.selected) {
                this.selected = tile;
                tile.list[0].setVisible(true); // Показать свечение
            } else {
                const dist = Math.abs(this.selected.gridR - tile.gridR) + Math.abs(this.selected.gridC - tile.gridC);
                if (dist === 1) {
                    await this.swapTiles(this.selected, tile);
                    this.executeTurn();
                }
                this.selected.list[0].setVisible(false);
                this.selected = null;
            }
        }

        async swapTiles(t1, t2) {
            this.canMove = false;
            const r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;

            return new Promise(res => {
                this.tweens.add({
                    targets: t1, x: c2 * 80 + 40, y: r2 * 80 + 40, duration: 200
                });
                this.tweens.add({
                    targets: t2, x: c1 * 80 + 40, y: r1 * 80 + 40, duration: 200,
                    onComplete: () => { this.canMove = true; res(); }
                });
            });
        }

        executeTurn() {
            // Базовый урон за ход
            window.appState.mob.hp -= window.appState.player.atk;
            window.appState.player.mp = Math.min(100, window.appState.player.mp + 10);
            addLog("Вы ударили врага!", "#4dff4d");
            
            updateUI();
            
            // Ход моба
            window.appState.turn = 'MOB';
            setTimeout(() => {
                window.appState.player.hp -= window.appState.mob.atk;
                addLog("Враг атакует!", "#ff4d4d");
                window.appState.turn = 'PLAYER';
                updateUI();
            }, 600);
        }
    }

    // --- ЗАПУСК ---
    function initGame(hero) {
        document.getElementById('start-menu').classList.add('hidden');
        document.getElementById('ui-left').classList.remove('hidden');
        document.getElementById('ui-right').classList.remove('hidden');

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 640, height: 640,
            scene: GameScene,
            transparent: true
        };
        new Phaser.Game(config);
        updateUI();
        addLog("Битва началась!");
    }

    function useAbility(type) {
        if (window.appState.turn !== 'PLAYER') return;
        
        const p = window.appState.player;
        if (type === 'strike' && p.mp >= 40) {
            p.mp -= 40;
            window.appState.mob.hp -= 30;
            addLog("СУПЕРУДАР: -30 HP врагу!", "#ffd700");
        } else if (type === 'heal' && p.mp >= 30) {
            p.mp -= 30;
            p.hp = Math.min(p.maxHp, p.hp + 40);
            addLog("ЛЕЧЕНИЕ: +40 HP", "#4dff4d");
        }
        updateUI();
    }
</script>

</body>
</html>
