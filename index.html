<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Radiant Ultimates - STABLE SKELETON</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 2px solid #b48c46; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>

    // ==========================================
    // [БЛОК 1] КОНСТАНТЫ И КОНФИГУРАЦИЯ
    // ==========================================
    const GW = 1200;
    const GH = 900;
    const GRID_SIZE = 8;
    const TILE_S = 70;
    const OFFSET_X = 420;
    const OFFSET_Y = 150;

    class MainScene extends Phaser.Scene {
        constructor() {
            super('MainScene');
        }

        // ==========================================
        // [БЛОК 2] ЗАГРУЗКА РЕСУРСОВ
        // ==========================================
        preload() {
            // Используем проверенные ассеты, которые всегда доступны
            this.load.image('tile_Red', 'https://labs.phaser.io/assets/sprites/gem.png');
            this.load.image('tile_Blue', 'https://labs.phaser.io/assets/sprites/diamond.png');
            this.load.image('tile_Green', 'https://labs.phaser.io/assets/sprites/shmup-ship.png');
            this.load.image('tile_Purple', 'https://labs.phaser.io/assets/sprites/wizball.png');
            this.load.image('tile_Yellow', 'https://labs.phaser.io/assets/sprites/coin.png');
        }

        create() {
            this.showMenu();
        }

        // ==========================================
        // [БЛОК 3] ГЕРОИ И ИНИЦИАЛИЗАЦИЯ
        // ==========================================
        showMenu() {
            this.children.removeAll();
            this.add.text(GW/2, 120, "ВЫБЕРИТЕ ГЕРОЯ", { fontSize: '50px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            
            const classes = ["Воин", "Маг", "Лучник", "Ассасин"];
            classes.forEach((name, i) => {
                let x = 300 * i + 150;
                let card = this.add.rectangle(x, 450, 260, 500, 0x1a1a1a).setInteractive().setStrokeStyle(3, 0xb48c46);
                this.add.text(x, 600, name, { fontSize: '36px', fill: '#fff' }).setOrigin(0.5);
                card.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            
            const hps = { "Воин": 1400, "Маг": 720, "Лучник": 880, "Ассасин": 800 };
            this.player = {
                job, level: 1, gold: 0, mana: 0, 
                hp: hps[job], maxHp: hps[job], arm: 0, baseAtk: 25,
                equip: {
                    head: { n: "Шлем", arm: 2, label: "Бр" },
                    body: { n: "Броня", arm: 5, label: "Бр" },
                    legs: { n: "Сапоги", arm: 2, label: "Бр" },
                    weapon: { n: "Меч", atk: 12, label: "Атк" },
                    ring: { n: "Кольцо", atk: 2, label: "Атк" },
                    neck: { n: "Амулет", arm: 0, label: "Бр" }
                }
            };

            this.isAnimating = false;
            this.selectedTile = null;
            this.currentTurnOwner = "PLAYER";

            this.updatePlayerStats();
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.updateUI();
        }

        updatePlayerStats() {
            this.player.arm = 0;
            this.player.bonusAtk = 0;
            for (let slot in this.player.equip) {
                let item = this.player.equip[slot];
                if (item.arm) this.player.arm += item.arm;
                if (item.atk) this.player.bonusAtk += item.atk;
            }
        }

        // ==========================================
        // [БЛОК 4] ИГРОВОЕ ПОЛЕ И ПЛИТКИ
        // ==========================================
        initGrid() {
            this.grid = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                this.grid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    this.spawnTile(r, c);
                }
            }
        }

        spawnTile(r, c, fromTop = false) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let tx = OFFSET_X + c * TILE_S;
            let ty = OFFSET_Y + r * TILE_S;

            let tile = this.add.image(tx, fromTop ? ty - 600 : ty, `tile_${type}`)
                .setDisplaySize(60, 60).setInteractive();
            
            tile.gridR = r;
            tile.gridC = c;
            tile.type = type;

            tile.on('pointerdown', () => this.handleTileClick(tile));
            this.grid[r][c] = tile;

            if (fromTop) {
                this.tweens.add({ targets: tile, y: ty, duration: 400, ease: 'Power2' });
            }
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.currentTurnOwner !== "PLAYER" || this.lootActive) return;

            if (!this.selectedTile) {
                this.selectedTile = tile;
                tile.setTint(0xffff00);
            } else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR);
                let dC = Math.abs(this.selectedTile.gridC - tile.gridC);

                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    let matched = await this.checkMatches();
                    if (!matched) {
                        await this.swapTiles(this.selectedTile, tile);
                    } else {
                        this.currentTurnOwner = "MOB";
                        this.time.delayedCall(800, () => this.mobAI());
                    }
                }
                this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;

            return new Promise(res => {
                this.tweens.add({ targets: t1, x: OFFSET_X + c2 * TILE_S, y: OFFSET_Y + r2 * TILE_S, duration: 200 });
                this.tweens.add({ targets: t2, x: OFFSET_X + c1 * TILE_S, y: OFFSET_Y + r1 * TILE_S, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        // ==========================================
        // [БЛОК 5] МАТЧИ И ЦЕПНАЯ РЕАКЦИЯ
        // ==========================================
        async checkMatches() {
            let toRem = new Set();
            // Горизонтали
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE-2; c++) {
                    let t1=this.grid[r][c], t2=this.grid[r][c+1], t3=this.grid[r][c+2];
                    if(t1 && t2 && t3 && t1.type===t2.type && t1.type===t3.type) { toRem.add(t1); toRem.add(t2); toRem.add(t3); }
                }
            }
            // Вертикали
            for(let c=0; c<GRID_SIZE; c++) {
                for(let r=0; r<GRID_SIZE-2; r++) {
                    let t1=this.grid[r][c], t2=this.grid[r+1][c], t3=this.grid[r+2][c];
                    if(t1 && t2 && t3 && t1.type===t2.type && t1.type===t3.type) { toRem.add(t1); toRem.add(t2); toRem.add(t3); }
                }
            }

            if (toRem.size > 0) {
                this.isAnimating = true;
                toRem.forEach(t => {
                    this.applyTileEffect(t.type);
                    this.grid[t.gridR][t.gridC] = null;
                    t.destroy();
                });
                await this.fillEmpty();
                await this.checkMatches(); // Рекурсия для комбо
                return true;
            }
            return false;
        }

        async fillEmpty() {
            let promises = [];
            for(let c=0; c<GRID_SIZE; c++) {
                let empty = 0;
                for(let r=GRID_SIZE-1; r>=0; r--) {
                    if(!this.grid[r][c]) empty++;
                    else if(empty > 0) {
                        let t = this.grid[r][c];
                        this.grid[r+empty][c] = t;
                        this.grid[r][c] = null;
                        t.gridR = r+empty;
                        promises.push(new Promise(res => {
                            this.tweens.add({ targets: t, y: OFFSET_Y + t.gridR * TILE_S, duration: 200, onComplete: res });
                        }));
                    }
                }
                for(let i=0; i<empty; i++) this.spawnTile(i, c, true);
            }
            return Promise.all(promises);
        }

        // ==========================================
        // [БЛОК 6] БОЕВАЯ ЛОГИКА И ХОД МОБА
        // ==========================================
        applyTileEffect(type) {
            if (this.currentTurnOwner === "PLAYER") {
                let dmg = this.player.baseAtk + (this.player.bonusAtk || 0);
                if (type === 'Red') this.mob.hp -= dmg;
                if (type === 'Blue') this.player.mana = Math.min(100, this.player.mana + 5);
                if (type === 'Green') this.player.hp = Math.min(this.player.maxHp, this.player.hp + 20);
                if (type === 'Yellow') this.player.gold += 2;
            } else {
                // Эффекты во время хода моба (урон игроку)
                if (type === 'Red' || type === 'Purple') {
                    let dmg = this.mob.atk;
                    if (this.player.arm >= dmg) this.player.arm -= dmg;
                    else { this.player.hp -= (dmg - this.player.arm); this.player.arm = 0; }
                }
            }
            this.updateUI();
        }

        spawnMob() {
            let lvl = this.player.level;
            this.mob = { name: "Враг Ур." + lvl, hp: 100 + lvl*50, maxHp: 100 + lvl*50, atk: 15 + lvl*5 };
        }

        async mobAI() {
            if (this.mob.hp <= 0) return;
            // Простейший ИИ: ищет первый доступный матч
            let moved = false;
            for (let r=0; r<GRID_SIZE && !moved; r++) {
                for (let c=0; c<GRID_SIZE-1 && !moved; c++) {
                    await this.swapTiles(this.grid[r][c], this.grid[r][c+1]);
                    if (await this.checkMatches()) moved = true;
                    else await this.swapTiles(this.grid[r][c], this.grid[r][c+1]);
                }
            }
            this.currentTurnOwner = "PLAYER";
            this.updateUI();
        }

        // ==========================================
        // [БЛОК 7] СИСТЕМА ЛУТА И ИНВЕНТАРЬ
        // ==========================================
        generateLoot() {
            const slots = [
                {n:'Шлем', s:'head', st:'arm', l:'Бр'},
                {n:'Броня', s:'body', st:'arm', l:'Бр'},
                {n:'Меч', s:'weapon', st:'atk', l:'Атк'}
            ];
            let s = Phaser.Utils.Array.GetRandom(slots);
            let val = this.player.level * 5 + Phaser.Math.Between(1, 10);
            return { name: s.n, slot: s.s, statType: s.st, label: s.l, val, price: val * 3 };
        }

        showLootWindow(loot) {
            this.lootActive = true;
            this.isAnimating = true;
            this.lootContainer = this.add.container(0, 0).setDepth(1000);
            
            let bg = this.add.rectangle(GW/2, GH/2, 500, 600, 0x111111).setStrokeStyle(4, 0xb48c46).setInteractive();
            let cur = this.player.equip[loot.slot];
            let curVal = cur ? (cur[loot.statType] || 0) : 0;
            let diff = loot.val - curVal;

            let info = `Новый: +${loot.val} ${loot.label}\nСтарый: +${curVal} ${loot.label}\nРазница: ${diff>0?'+':''}${diff}`;
            let txt = this.add.text(GW/2, GH/2-50, info, { fontSize: '28px', fill: '#fff', align: 'center' }).setOrigin(0.5);
            
            let btn = this.add.rectangle(GW/2, GH/2+200, 200, 60, 0x224422).setInteractive().setStrokeStyle(2, 0x00ff00);
            let btnTxt = this.add.text(GW/2, GH/2+200, "НАДЕТЬ", { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);

            btn.on('pointerdown', () => {
                this.player.equip[loot.slot] = { n: loot.name, [loot.statType]: loot.val, label: loot.label };
                this.lootContainer.destroy();
                this.lootActive = false;
                this.isAnimating = false;
                this.player.level++;
                this.updatePlayerStats();
                this.spawnMob();
                this.updateUI();
            });

            this.lootContainer.add([bg, txt, btn, btnTxt]);
        }

        // ==========================================
        // [БЛОК 8] ИНТЕРФЕЙС
        // ==========================================
        createUI() {
            this.add.rectangle(180, 450, 320, 850, 0x1a1a1a).setStrokeStyle(2, 0xb48c46);
            this.hpText = this.add.text(40, 60, "", { fontSize: '24px', fill: '#ff4444', fontStyle: 'bold' });
            this.goldText = this.add.text(40, 160, "", { fontSize: '24px', fill: '#ffd700' });
            this.invText = this.add.text(40, 350, "ИНВЕНТАРЬ:", { fontSize: '22px', fill: '#ffd700', fontStyle: 'bold' });
            this.itemsText = this.add.text(40, 400, "", { fontSize: '18px', fill: '#fff', lineSpacing: 10 });
            this.mobHpText = this.add.text(1020, 200, "", { fontSize: '28px', fill: '#ff0000', align: 'center' }).setOrigin(0.5);
        }

        updateUI() {
            this.hpText.setText(`HP: ${Math.floor(this.player.hp)} / ${this.player.maxHp}\nБРОНЯ: ${this.player.arm}`);
            this.goldText.setText(`ЗОЛОТО: ${this.player.gold}\nМАНА: ${this.player.mana}%`);
            
            let items = "";
            for (let s in this.player.equip) {
                let i = this.player.equip[s];
                items += `${i.n}: +${i.atk || i.arm} ${i.label}\n`;
            }
            this.itemsText.setText(items);

            this.mobHpText.setText(`${this.mob.name}\nHP: ${Math.floor(this.mob.hp)}`);

            if (this.mob.hp <= 0 && !this.lootActive) {
                this.showLootWindow(this.generateLoot());
            }
            if (this.player.hp <= 0) {
                alert("ИГРА ОКОНЧЕНА");
                location.reload();
            }
        }
    }

    const config = { type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, backgroundColor: '#0c0a08', scene: [MainScene] };
    new Phaser.Game(config);
    </script>
</body>
</html>
