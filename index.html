<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Bunker Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        :root { --gold: #ffd700; --border: #b48c46; }
        body { 
            margin: 0; background: #0c0a08; color: white;
            display: flex; height: 100vh; width: 100vw; overflow: hidden;
            font-family: 'Courier New', monospace; touch-action: none;
        }
        /* ЛЕВАЯ ПАНЕЛЬ */
        #ui-left {
            width: 300px; border-right: 2px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; background: #000;
        }
        /* ПРАВАЯ ПАНЕЛЬ */
        #ui-right {
            width: 300px; border-left: 2px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; background: #000;
        }
        /* ИГРОВОЕ ПОЛЕ */
        #game-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #0c0a08; }
        
        .stat-label { font-size: 14px; color: #aaa; margin-top: 10px; }
        .stat-value { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .hp-bar-bg { width: 100%; height: 20px; background: #300; border: 1px solid #500; margin-bottom: 15px; }
        #hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s; }
        
        #ult-btn {
            background: #404; border: 2px solid #f0f; color: white; padding: 15px;
            text-align: center; cursor: pointer; font-weight: bold; margin-top: 20px;
        }
        #ult-btn:active { background: #606; }
        
        #loot-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .loot-window { border: 3px solid var(--gold); padding: 40px; background: #111; text-align: center; }
    </style>
</head>
<body>

    <div id="ui-left">
        <div id="hero-img" style="width:150px; height:150px; border:1px solid var(--border); margin: 0 auto;"></div>
        <div class="stat-label">ЗДОРОВЬЕ</div>
        <div id="hp-text" class="stat-value">1400 / 1400</div>
        <div class="hp-bar-bg"><div id="hp-fill"></div></div>
        
        <div class="stat-label">ЗОЛОТО</div>
        <div id="gold-text" class="stat-value" style="color:var(--gold)">0</div>
        
        <div id="ult-btn" onclick="triggerUlt()">СУПЕРУДАР</div>
        
        <div class="stat-label" style="margin-top:40px">ИНВЕНТАРЬ</div>
        <div id="inv-list" style="font-size: 12px; color: #888; line-height: 1.6;">
            Меч: +12 Атк<br>Шлем: +2 Бр<br>Броня: +5 Бр
        </div>
    </div>

    <div id="game-container"></div>

    <div id="ui-right">
        <div class="stat-label">ПРОТИВНИК</div>
        <div id="mob-name" class="stat-value" style="color:#f44">Монстр Ур.1</div>
        <div class="hp-bar-bg"><div id="mob-hp-fill" style="background:#f00"></div></div>
        <div id="mob-hp-text" style="text-align:right">160 / 160</div>
    </div>

    <div id="loot-overlay" id="loot-window">
        <div class="loot-window">
            <h1 style="color:var(--gold)">ПОБЕДА!</h1>
            <button onclick="nextLevel()" style="padding:10px 30px; cursor:pointer">ПРОДОЛЖИТЬ</button>
        </div>
    </div>

    <script>
    const TILE_S = 70;
    let game;

    class GameScene extends Phaser.Scene {
        constructor() { super('GameScene'); }
        preload() {
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => 
                this.load.image(`tile_${c}`, `assets/rune_${c.toLowerCase()}.png`)
            );
        }

        create() {
            this.grid = [];
            this.isAnimating = false;
            this.player = window.appData.player;
            this.spawnGrid();
        }

        spawnGrid() {
            for (let r=0; r<8; r++) {
                this.grid[r] = [];
                for (let c=0; c<8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c, fromTop = false) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let x = c * TILE_S + TILE_S/2;
            let y = r * TILE_S + TILE_S/2;
            let tile = this.add.image(x, fromTop ? y - 500 : y, `tile_${type}`).setDisplaySize(64, 64).setInteractive();
            tile.gridR = r; tile.gridC = c; tile.type = type;

            tile.on('pointerdown', () => this.handleTileClick(tile));
            this.grid[r][c] = tile;
            if (fromTop) this.tweens.add({ targets: tile, y: y, duration: 300 });
        }

        async handleTileClick(tile) {
            if (this.isAnimating || window.appData.lootActive) return;
            if (!this.selectedTile) {
                this.selectedTile = tile; tile.setTint(0xffff00);
            } else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR), dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    if (!await this.checkMatches()) await this.swapTiles(this.selectedTile, tile);
                    else { updateLogic("turn"); }
                }
                if(this.selectedTile) this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: c2*TILE_S+TILE_S/2, y: r2*TILE_S+TILE_S/2, duration: 200 });
                this.tweens.add({ targets: t2, x: c1*TILE_S+TILE_S/2, y: r1*TILE_S+TILE_S/2, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        async checkMatches() {
            let toRem = new Set();
            for(let r=0; r<8; r++) for(let c=0; c<6; c++) {
                if(this.grid[r][c] && this.grid[r][c+1] && this.grid[r][c+2] && this.grid[r][c].type === this.grid[r][c+1].type && this.grid[r][c].type === this.grid[r][c+2].type)
                    [this.grid[r][c], this.grid[r][c+1], this.grid[r][c+2]].forEach(t => toRem.add(t));
            }
            // (Проверка вертикалей аналогично...)
            if (toRem.size > 0) {
                toRem.forEach(t => { applyTileEffect(t.type); this.grid[t.gridR][t.gridC] = null; t.destroy(); });
                await this.fillEmpty(); await this.checkMatches(); return true;
            }
            return false;
        }

        async fillEmpty() {
            for(let c=0; c<8; c++) {
                let empty = 0;
                for(let r=7; r>=0; r--) {
                    if(!this.grid[r][c]) empty++;
                    else if(empty > 0) {
                        let t = this.grid[r][c]; this.grid[r+empty][c] = t; this.grid[r][c] = null; t.gridR = r+empty;
                        this.tweens.add({ targets: t, y: t.gridR * TILE_S + TILE_S/2, duration: 200 });
                    }
                }
                for(let i=0; i<empty; i++) this.spawnTile(i, c, true);
            }
            await new Promise(res => this.time.delayedCall(250, res));
        }
    }

    // ДАННЫЕ И ЛОГИКА (ВНЕ PHASER) [cite: 2026-02-08, 2026-02-09]
    window.appData = {
        player: { hp: 1400, maxHp: 1400, gold: 0, mana: 0 },
        mob: { hp: 160, maxHp: 160, name: "Монстр Ур.1" },
        lootActive: false
    };

    function updateLogic(type) {
        if (window.appData.mob.hp <= 0) {
            document.getElementById('loot-overlay').style.display = 'flex';
            window.appData.lootActive = true;
        }
        refreshUI();
    }

    function applyTileEffect(type) {
        if (type === 'Red') window.appData.mob.hp -= 20;
        if (type === 'Yellow') window.appData.gold += 5;
        if (type === 'Green') window.appData.player.hp = Math.min(window.appData.player.maxHp, window.appData.player.hp + 10);
        updateLogic();
    }

    function refreshUI() {
        document.getElementById('hp-text').innerText = `${Math.floor(window.appData.player.hp)} / ${window.appData.player.maxHp}`;
        document.getElementById('hp-fill').style.width = (window.appData.player.hp / window.appData.player.maxHp * 100) + '%';
        document.getElementById('gold-text').innerText = window.appData.gold;
        document.getElementById('mob-hp-text').innerText = `${Math.floor(window.appData.mob.hp)} / ${window.appData.mob.maxHp}`;
        document.getElementById('mob-hp-fill').style.width = (window.appData.mob.hp / window.appData.mob.maxHp * 100) + '%';
    }

    function triggerUlt() {
        window.appData.mob.hp -= 100;
        updateLogic();
    }

    function nextLevel() {
        window.appData.lootActive = false;
        document.getElementById('loot-overlay').style.display = 'none';
        window.appData.mob.hp = 200; // Усиление моба
        refreshUI();
    }

    const config = {
        type: Phaser.AUTO,
        parent: 'game-container',
        width: 8 * TILE_S,
        height: 8 * TILE_S,
        scene: GameScene,
        backgroundColor: '#0c0a08'
    };
    game = new Phaser.Game(config);
    </script>
</body>
</html>
