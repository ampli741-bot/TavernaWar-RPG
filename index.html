<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Radiant Ultimates</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    const GW = 1200, GH = 900, OFFSET_X = 400, OFFSET_Y = 140, TILE_S = 68;

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            this.load.image('hero_–í–æ–∏–Ω', 'https://placehold.co/200x200/orange/white?text=WARRIOR');
            this.load.image('hero_–ú–∞–≥', 'https://placehold.co/200x200/blue/white?text=MAGE');
            this.load.image('hero_–õ—É—á–Ω–∏–∫', 'https://placehold.co/200x200/green/white?text=ARCHER');
            this.load.image('hero_–ê—Å—Å–∞—Å–∏–Ω', 'https://placehold.co/200x200/purple/white?text=ASSASSIN');
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => 
                this.load.image(`tile_${c}`, `https://placehold.co/64x64/${c.toLowerCase()}/white?text=${c[0]}`)
            );
        }

        create() { this.showMenu(); }

        showMenu() {
            this.children.removeAll();
            this.add.text(GW/2, 100, "–í–´–ë–ï–†–ò–¢–ï –ì–ï–†–û–Ø", { fontSize: '42px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            ["–í–æ–∏–Ω", "–ú–∞–≥", "–õ—É—á–Ω–∏–∫", "–ê—Å—Å–∞—Å–∏–Ω"].forEach((name, i) => {
                let x = 300 * i + 150;
                let card = this.add.rectangle(x, 450, 260, 550, 0x1a1a1a).setInteractive().setStrokeStyle(2, 0xb48c46);
                this.add.text(x, 600, name, { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
                card.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            const hps = { "–í–æ–∏–Ω": 1400, "–ú–∞–≥": 720, "–õ—É—á–Ω–∏–∫": 880, "–ê—Å—Å–∞—Å–∏–Ω": 800 };
            this.player = {
                job, maxHp: hps[job], hp: hps[job], arm: 0, shield: 0, mana: 0, gold: 0, level: 1, baseAtk: 35, combo: 1,
                equip: {
                    head: { n: "–ü—É—Å—Ç–æ", atk: 0, arm: 0, color: '#666' },
                    body: { n: "–ü—É—Å—Ç–æ", atk: 0, arm: 0, color: '#666' },
                    weapon: { n: "–ú–µ—á", atk: 10, arm: 0, color: '#fff' }
                }
            };
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.updateUI();
        }

        spawnMob() {
            let lvl = this.player.level;
            this.mob = { name: "‚ò†Ô∏è –í—Ä–∞–≥ –£—Ä." + lvl, maxHp: 120 + (lvl*90), hp: 120 + (lvl*90), atk: 15 + (lvl*8), mana: 0 };
            this.turn = "PLAYER";
            this.lootActive = false;
            this.addLog(`--- –í–û–õ–ù–ê ${lvl} ---`, '#ffd700');
        }

        // ==========================================
        // [–ë–õ–û–ö: –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–´–ï –°–ü–û–°–û–ë–ù–û–°–¢–ò]
        // ==========================================
        async executeUlt() {
            if (this.player.mana < 100 || this.isAnimating) return;
            this.player.mana = 0;
            this.isAnimating = true;
            let toRemove = [];

            if (this.player.job === "–í–æ–∏–Ω") {
                this.addLog("–£–õ–¨–¢–ê: –ì–ù–ï–í –í–û–ò–ù–ê (–ö—Ä–∞—Å–Ω—ã–µ –∏ –ó–µ–ª–µ–Ω—ã–µ)", '#ff4400');
                this.grid.flat().forEach(t => { if(t && (t.type === 'Red' || t.type === 'Green')) toRemove.push(t); });
            } 
            else if (this.player.job === "–ú–∞–≥") {
                this.addLog("–£–õ–¨–¢–ê: –©–ò–¢ –ú–ê–ì–ê (–§–∏–æ–ª –∏ –ñ–µ–ª—Ç—ã–µ)", '#4444ff');
                this.player.shield = Math.floor(this.player.hp * 0.20);
                this.grid.flat().forEach(t => { if(t && (t.type === 'Purple' || t.type === 'Yellow')) toRemove.push(t); });
            } 
            else if (this.player.job === "–õ—É—á–Ω–∏–∫") {
                this.addLog("–£–õ–¨–¢–ê: –ó–ê–õ–ü –õ–£–ß–ù–ò–ö–ê (4 –ü–æ–ª–æ—Å—ã)", '#00ff00');
                let rows = Phaser.Utils.Array.NumberArray(0, 7);
                Phaser.Utils.Array.Shuffle(rows).slice(0, 4).forEach(r => {
                    for(let c=0; c<8; c++) if(this.grid[r][c]) toRemove.push(this.grid[r][c]);
                });
            } 
            else if (this.player.job === "–ê—Å—Å–∞—Å–∏–Ω") {
                this.addLog("–£–õ–¨–¢–ê: –¢–ï–ù–ï–í–û–ô –†–ê–ó–†–ï–ó (30% –∫–ª–µ—Ç–æ–∫)", '#8800ff');
                let all = this.grid.flat().filter(t => t !== null);
                let count = Math.floor(all.length * 0.3);
                toRemove = Phaser.Utils.Array.Shuffle(all).slice(0, count);
                let totalAtk = this.player.baseAtk + (this.player.equip.weapon.atk || 0);
                this.mob.hp -= totalAtk;
            }

            // –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏
            toRemove.forEach(t => {
                if(t) {
                    this.applyEffect(t.type);
                    this.tweens.add({ targets: t, tint: 0xffffff, alpha: 0, scale: 1.2, duration: 400 });
                }
            });

            this.time.delayedCall(450, async () => {
                toRemove.forEach(t => { if(t) { this.grid[t.gridR][t.gridC] = null; t.destroy(); }});
                await this.fillEmpty();
                this.isAnimating = false;
                this.updateUI();
                this.time.delayedCall(600, () => this.mobAI());
            });
        }

        // ==========================================
        // [–ë–õ–û–ö: –°–ï–¢–ö–ê –ò –ö–ê–°–ö–ê–î–´]
        // ==========================================
        initGrid() {
            this.grid = [];
            for (let r = 0; r < 8; r++) {
                this.grid[r] = [];
                for (let c = 0; c < 8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c, fromTop = false) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let tx = OFFSET_X + c * TILE_S, ty = OFFSET_Y + r * TILE_S;
            let tile = this.add.image(tx, fromTop ? ty - 500 : ty, `tile_${type}`).setDisplaySize(60, 60).setInteractive().setDepth(2);
            tile.gridR = r; tile.gridC = c; tile.type = type;
            tile.on('pointerdown', (p) => { if(!this.lootActive && p.x > 366 && p.x < 910) this.handleTileClick(tile); });
            this.grid[r][c] = tile;
            if (fromTop) this.tweens.add({ targets: tile, y: ty, duration: 400 });
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.turn !== "PLAYER") return;
            if (!this.selectedTile) { this.selectedTile = tile; tile.setTint(0xffff00); }
            else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR), dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    this.player.combo = 1;
                    if (!await this.checkMatches()) await this.swapTiles(this.selectedTile, tile);
                    else { this.turn = "MOB"; this.time.delayedCall(600, () => this.mobAI()); }
                }
                if (this.selectedTile) this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: OFFSET_X+c2*TILE_S, y: OFFSET_Y+r2*TILE_S, duration: 200 });
                this.tweens.add({ targets: t2, x: OFFSET_X+c1*TILE_S, y: OFFSET_Y+r1*TILE_S, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        async checkMatches() {
            let toRem = new Set();
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    if(c<6 && this.grid[r][c] && this.grid[r][c+1] && this.grid[r][c+2] && this.grid[r][c].type === this.grid[r][c+1].type && this.grid[r][c].type === this.grid[r][c+2].type) {
                        [0,1,2].forEach(i => toRem.add(this.grid[r][c+i]));
                        if(c<5 && this.grid[r][c+3] && this.grid[r][c].type === this.grid[r][c+3].type) { // 4 –≤ —Ä—è–¥
                            for(let i=0; i<8; i++) if(this.grid[r][i]) toRem.add(this.grid[r][i]);
                        }
                        if(c<4 && this.grid[r][c+4] && this.grid[r][c].type === this.grid[r][c+4].type) { // 5 –≤ —Ä—è–¥
                            this.explode(r, c+2, toRem);
                        }
                    }
                    if(r<6 && this.grid[r][c] && this.grid[r+1][c] && this.grid[r+2][c] && this.grid[r][c].type === this.grid[r+1][c].type && this.grid[r][c].type === this.grid[r+2][c].type) {
                        [0,1,2].forEach(i => toRem.add(this.grid[r+i][c]));
                        if(r<5 && this.grid[r+3][c] && this.grid[r][c].type === this.grid[r+3][c].type) { // 4 –≤ —Ä—è–¥
                            for(let i=0; i<8; i++) if(this.grid[i][c]) toRem.add(this.grid[i][c]);
                        }
                    }
                }
            }
            if (toRem.size > 0) { 
                toRem.forEach(t => { if(t) { this.applyEffect(t.type); this.grid[t.gridR][t.gridC] = null; t.destroy(); }});
                await this.fillEmpty(); 
                this.player.combo *= 1.2; 
                await this.checkMatches(); 
                return true; 
            }
            return false;
        }

        explode(r, c, set) {
            for(let i=r-1; i<=r+1; i++) for(let j=c-1; j<=c+1; j++) {
                if(i>=0 && i<8 && j>=0 && j<8 && this.grid[i][j]) set.add(this.grid[i][j]);
            }
            this.addLog("üí• –ú–û–©–ù–´–ô –í–ó–†–´–í!", '#ff0000');
        }

        async fillEmpty() {
            for(let c=0; c<8; c++) {
                let empty = 0;
                for(let r=7; r>=0; r--) { 
                    if(!this.grid[r][c]) empty++; 
                    else if(empty > 0) { 
                        let t = this.grid[r][c]; this.grid[r+empty][c] = t; this.grid[r][c] = null; t.gridR = r+empty; 
                        this.tweens.add({ targets: t, y: OFFSET_Y+t.gridR*TILE_S, duration: 250 }); 
                    } 
                }
                for(let i=0; i<empty; i++) this.spawnTile(i, c, true);
            }
            await new Promise(res => this.time.delayedCall(300, res));
        }

        // ==========================================
        // [–ë–õ–û–ö: –ë–û–ô –ò UI]
        // ==========================================
        applyEffect(type) {
            let mult = this.player.combo;
            let atk = this.player.baseAtk + Object.values(this.player.equip).reduce((a,b)=>a+(b.atk||0), 0);
            if (type === 'Red' || type === 'Purple') this.mob.hp -= Math.floor((atk/8) * mult);
            if (type === 'Green') this.player.hp = Math.min(this.player.maxHp, this.player.hp + Math.floor(12 * mult));
            if (type === 'Blue') this.player.mana = Math.min(100, this.player.mana + Math.floor(6 * mult));
            if (type === 'Yellow') this.player.gold += Math.floor(3 * mult);
            this.updateUI();
        }

        async mobAI() {
            if (this.mob.hp <= 0 || this.lootActive) return;
            this.mob.mana += 20;
            let dmg = Math.max(5, this.mob.atk - this.player.arm);
            
            // –°–Ω–∞—á–∞–ª–∞ –±—å–µ–º —â–∏—Ç
            if (this.player.shield > 0) {
                let toShield = Math.min(this.player.shield, dmg);
                this.player.shield -= toShield;
                dmg -= toShield;
                this.addLog(`–©–∏—Ç –ø–æ–≥–ª–æ—Ç–∏–ª ${toShield} —É—Ä–æ–Ω–∞`, '#00ffff');
            }
            if (dmg > 0) this.player.hp -= dmg;
            
            this.addLog(`${this.mob.name} –ê–¢–ê–ö–£–ï–¢!`, '#ff4444');
            if (this.mob.mana >= 100) {
                this.mob.mana = 0;
                this.addLog(`‚ö° –Ø–†–û–°–¢–¨ –ú–û–ù–°–¢–†–ê: –í–¢–û–†–û–ô –•–û–î!`, '#ffff00');
                this.player.hp -= Math.floor(dmg * 0.7);
            }
            this.turn = "PLAYER"; this.updateUI();
        }

        createUI() {
            // –§–æ–Ω –ø–∞–Ω–µ–ª–µ–π
            this.add.rectangle(0, 0, 366, GH, 0x12100e).setOrigin(0).setStrokeStyle(2, 0xb48c46);
            this.add.rectangle(910, 0, 290, GH, 0x12100e).setOrigin(0).setStrokeStyle(2, 0xb48c46);
            
            // –ü–µ—Ä—Å–æ–Ω–∞–∂
            this.add.image(183, 120, `hero_${this.player.job}`).setDisplaySize(160, 160);
            this.hpBar = this.add.graphics();
            this.manaBar = this.add.graphics();
            this.hpTxt = this.add.text(40, 240, "", { fontSize: '18px', fill: '#ff4444', fontStyle: 'bold' });
            this.manaTxt = this.add.text(40, 290, "", { fontSize: '18px', fill: '#4444ff', fontStyle: 'bold' });
            this.goldTxt = this.add.text(183, 360, "", { fontSize: '24px', fill: '#ffd700' }).setOrigin(0.5);

            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            this.invTxts = {};
            ['head', 'body', 'weapon'].forEach((s, i) => {
                this.invTxts[s] = this.add.text(40, 420 + (i*35), "", { fontSize: '16px' });
            });

            // –ö–Ω–æ–ø–∫–∞ –£–ª—å—Ç—ã
            this.ultBtn = this.add.rectangle(183, 600, 280, 50, 0x440044).setInteractive().setStrokeStyle(2, 0xff00ff);
            this.ultTxt = this.add.text(183, 600, "–°–£–ü–ï–†–£–î–ê–†", { fontSize: '18px' }).setOrigin(0.5);
            this.ultBtn.on('pointerdown', () => this.executeUlt());

            // –ú–æ–±
            this.mobIcon = this.add.text(1055, 120, "üòé", { fontSize: '100px' }).setOrigin(0.5);
            this.mobHpBar = this.add.graphics();
            this.mobManaBar = this.add.graphics();
            this.mobNameTxt = this.add.text(1055, 230, "", { fontSize: '20px', fill: '#ff0000', align: 'center' }).setOrigin(0.5);

            // –õ–æ–≥ –±–æ—è
            this.logTexts = [];
            for (let i = 0; i < 5; i++) this.logTexts.push(this.add.text(GW/2, 750 + (i * 22), "", { fontSize: '16px' }).setOrigin(0.5));
        }

        updateUI() {
            if (!this.player || !this.mob) return;
            this.player.arm = Object.values(this.player.equip).reduce((a, b) => a + (b.arm || 0), 0);
            
            // –ë–∞—Ä—ã –∏–≥—Ä–æ–∫–∞
            this.hpBar.clear().fillStyle(0x330000).fillRect(40, 265, 280, 15).fillStyle(0xff0000).fillRect(40, 265, (this.player.hp/this.player.maxHp)*280, 15);
            if(this.player.shield > 0) this.hpBar.lineStyle(3, 0xffffff).strokeRect(40, 265, (this.player.hp/this.player.maxHp)*280, 15);
            
            this.manaBar.clear().fillStyle(0x000033).fillRect(40, 315, 280, 15).fillStyle(0x4444ff).fillRect(40, 315, (this.player.mana/100)*280, 15);
            this.hpTxt.setText(`HP: ${Math.floor(this.player.hp)} / ${this.player.maxHp} ${this.player.shield > 0 ? '(üõ°Ô∏è'+this.player.shield+')' : ''}`);
            this.manaTxt.setText(`MANA: ${this.player.mana} / 100`);
            this.goldTxt.setText(`–ó–û–õ–û–¢–û: ${this.player.gold} üí∞`);

            for (let k in this.invTxts) { 
                let itm = this.player.equip[k]; 
                this.invTxts[k].setText(`${k.toUpperCase()}: ${itm.n} (${itm.atk||itm.arm > 0 ? '+' : ''}${itm.atk||itm.arm})`).setFill(itm.color); 
            }

            // –ë–∞—Ä—ã –º–æ–±–∞
            this.mobNameTxt.setText(`${this.mob.name}\nHP: ${Math.floor(this.mob.hp)}`);
            this.mobHpBar.clear().fillStyle(0x330000).fillRect(930, 280, 250, 15).fillStyle(0xff0000).fillRect(930, 280, (Math.max(0, this.mob.hp)/this.mob.maxHp)*250, 15);
            this.mobManaBar.clear().fillStyle(0x222222).fillRect(930, 300, 250, 5).fillStyle(0xffff00).fillRect(930, 300, (this.mob.mana/100)*250, 5);

            if (this.mob.hp <= 0 && !this.lootActive) this.showLootChoice();
            if (this.player.hp <= 0) location.reload();
        }

        showLootChoice() {
            this.lootActive = true;
            const rs = [{n:'–û–±—ã—á–Ω—ã–π',c:'#fff',m:1},{n:'–†–µ–¥–∫–∏–π',c:'#00ff00',m:2.5},{n:'–õ–ï–ì–ï–ù–î–ê',c:'#ff8c00',m:6}];
            let r = rs[Phaser.Math.Between(0, 2)];
            let slot = Phaser.Utils.Array.GetRandom(['head','body','weapon']);
            let val = Math.floor(this.player.level * 8 * r.m);
            let loot = { n: slot.toUpperCase() + " " + r.n, slot, val, color: r.c, atk: slot==='weapon'?val:0, arm: slot!=='weapon'?val:0 };
            let current = this.player.equip[slot];

            this.lootBox = this.add.container(GW/2, GH/2).setDepth(10000);
            let bg = this.add.rectangle(0, 0, 600, 400, 0x000, 0.95).setStrokeStyle(4, 0xb48c46);
            let t1 = this.add.text(0, -140, "–¢–†–û–§–ï–ô –ü–û–ë–ï–î–ò–¢–ï–õ–Ø", {fontSize:'30px', fill:'#ffd700'}).setOrigin(0.5);
            let t2 = this.add.text(0, -50, `–ù–û–í–û–ï: ${loot.n} (+${loot.val})\n–ù–ê–î–ï–¢–û: ${current.n} (+${current.atk||current.arm})`, {fontSize:'20px', align:'center'}).setOrigin(0.5);
            
            let btn1 = this.add.rectangle(-140, 100, 200, 60, 0x006600).setInteractive();
            let btn1T = this.add.text(-140, 100, "–ù–ê–î–ï–¢–¨").setOrigin(0.5);
            let btn2 = this.add.rectangle(140, 100, 200, 60, 0x666600).setInteractive();
            let btn2T = this.add.text(140, 100, `–ü–†–û–î–ê–¢–¨ (${val*3}üí∞)`).setOrigin(0.5);

            this.lootBox.add([bg, t1, t2, btn1, btn1T, btn2, btn2T]);

            btn1.on('pointerdown', () => { this.player.equip[slot] = loot; this.closeLoot(); });
            btn2.on('pointerdown', () => { this.player.gold += (val*3); this.closeLoot(); });
        }

        closeLoot() {
            this.player.level++;
            this.player.shield = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —â–∏—Ç –º–µ–∂–¥—É –±–æ—è–º–∏
            this.lootBox.destroy();
            this.spawnMob();
            this.updateUI();
        }

        addLog(m, c) {
            this.logTexts.unshift(this.logTexts.pop());
            this.logTexts[0].setText(m).setFill(c);
            this.logTexts.forEach((t, i) => t.setY(750 + (i * 22)));
        }
    }

    new Phaser.Game({ type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, scene: [MainScene] });
    </script>
</body>
</html>
