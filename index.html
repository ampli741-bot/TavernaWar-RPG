<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Radiant Ultimates</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 2px solid #b48c46; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    const GW = 1200, GH = 900, OFFSET_X = 400, OFFSET_Y = 140, TILE_S = 68;

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        // ==========================================
        // [БЛОК 0] ЗАГРУЗКА РЕСУРСОВ
        // ==========================================
        preload() {
            this.load.image('hero_Воин', 'assets/hero_warrior.png');
            this.load.image('hero_Маг', 'assets/hero_mage.png');
            this.load.image('hero_Лучник', 'assets/archer.png');
            this.load.image('hero_Ассасин', 'assets/assasin.png');
            this.load.image('mob_icon', 'assets/hero_warrior.png');
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => 
                this.load.image(`tile_${c}`, `assets/rune_${c.toLowerCase()}.png`)
            );
        }

        create() { this.showMenu(); }

        // ==========================================
        // [БЛОК 1] МЕНЮ И ПАРАМЕТРЫ ИГРОКА
        // ==========================================
        showMenu() {
            this.children.removeAll();
            this.add.text(GW/2, 100, "ВЫБЕРИТЕ ГЕРОЯ", { fontSize: '42px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            ["Воин", "Маг", "Лучник", "Ассасин"].forEach((name, i) => {
                let x = 300 * i + 150;
                let card = this.add.rectangle(x, 450, 260, 550, 0x1a1a1a).setInteractive().setStrokeStyle(2, 0xb48c46);
                this.add.image(x, 400, `hero_${name}`).setDisplaySize(200, 200);
                this.add.text(x, 600, name, { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
                card.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            const hps = { "Воин": 1400, "Маг": 720, "Лучник": 880, "Ассасин": 800 };
            this.player = {
                job, maxHp: hps[job], hp: hps[job], arm: 0, mana: 0, gold: 0, level: 1, baseAtk: 25,
                equip: {
                    head: { n: "Шлем", atk: 0, arm: 2, color: '#ffffff' },
                    body: { n: "Броня", atk: 0, arm: 5, color: '#ffffff' },
                    legs: { n: "Сапоги", atk: 0, arm: 2, color: '#ffffff' },
                    weapon: { n: "Меч", atk: 12, arm: 0, color: '#ffffff' },
                    ring: { n: "Кольцо", atk: 2, arm: 0, color: '#ffffff' },
                    neck: { n: "Амулет", atk: 0, arm: 0, color: '#ffffff' }
                }
            };
            this.player.arm = Object.values(this.player.equip).reduce((a, b) => a + (b.arm || 0), 0);
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.updateUI();
        }

        // ==========================================
        // [БЛОК 2] МОБЫ И СИСТЕМА ЛУТА
        // ==========================================
        spawnMob() {
            let lvl = this.player.level;
            this.mob = { 
                name: "Монстр Ур." + lvl, 
                maxHp: 100 + (lvl*60), hp: 100 + (lvl*60), 
                atk: 15 + (lvl*10), mana: 0 
            };
            this.turn = "PLAYER";
            this.lootActive = false;
        }

        generateLoot() {
            const rarities = [
                { n: 'Обычный', c: '#ffffff', mult: 1, chance: 60 },
                { n: 'Редкий', c: '#00ff00', mult: 1.6, chance: 20 },
                { n: 'Эпический', c: '#800080', mult: 2.5, chance: 12 },
                { n: 'Легендарный', c: '#ff8c00', mult: 4, chance: 6 },
                { n: 'ДРЕВНИЙ', c: '#00ffff', mult: 6, chance: 2 }
            ];
            let rand = Phaser.Math.Between(1, 100);
            let cum = 0, rarity = rarities[0];
            for (let r of rarities) { cum += r.chance; if (rand <= cum) { rarity = r; break; } }

            const slots = [
                {n:'Шлем', s:'head', st:'arm', label: 'Броня'}, {n:'Доспех', s:'body', st:'arm', label: 'Броня'}, {n:'Сапоги', s:'legs', st:'arm', label: 'Броня'},
                {n:'Меч', s:'weapon', st:'atk', label: 'Атака'}, {n:'Кольцо', s:'ring', st:'atk', label: 'Атака'}, {n:'Амулет', s:'neck', st:'atk', label: 'Атака'}
            ];
            let item = Phaser.Utils.Array.GetRandom(slots);
            let baseVal = Math.floor(this.player.level * 3 * rarity.mult);
            let finalVal = baseVal + Phaser.Math.Between(1, 5);

            return { name: item.n, slot: item.s, statType: item.st, label: item.label, val: finalVal, rarity: rarity.n, color: rarity.c, price: Math.floor(finalVal * 2) };
        }

        showLootWindow(loot) {
            this.lootActive = true;
            const current = this.player.equip[loot.slot];
            const currentVal = current[loot.statType] || 0;
            const diff = loot.val - currentVal;

            this.lootContainer = this.add.container(GW/2, GH/2).setDepth(1000);
            let bg = this.add.rectangle(0, 0, 500, 500, 0x000000, 0.9).setStrokeStyle(3, 0xb48c46).setInteractive();
            let title = this.add.text(0, -200, "ТРОФЕЙ НАЙДЕН!", { fontSize: '32px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            let itemName = this.add.text(0, -120, `${loot.rarity} ${loot.name}`, { fontSize: '30px', fill: loot.color, fontStyle: 'bold' }).setOrigin(0.5);
            
            let info = this.add.text(0, 0, 
                `Новый: +${loot.val} ${loot.label}\n` +
                `Текущий: +${currentVal} ${loot.label}\n` +
                `Разница: ${diff > 0 ? '+' : ''}${diff}`, 
                { fontSize: '26px', align: 'center', fill: '#ffffff', fontStyle: 'bold' }
            ).setOrigin(0.5);

            let btnEquip = this.add.rectangle(-120, 180, 200, 60, 0x224422).setInteractive().setStrokeStyle(2, 0x00ff00);
            let txtEquip = this.add.text(-120, 180, "НАДЕТЬ", { fontSize: '22px', fontStyle: 'bold' }).setOrigin(0.5);

            let btnSell = this.add.rectangle(120, 180, 200, 60, 0x442222).setInteractive().setStrokeStyle(2, 0xff0000);
            let txtSell = this.add.text(120, 180, `ПРОДАТЬ (${loot.price})`, { fontSize: '20px', fontStyle: 'bold' }).setOrigin(0.5);

            this.lootContainer.add([bg, title, itemName, info, btnEquip, txtEquip, btnSell, txtSell]);

            btnEquip.on('pointerdown', () => {
                this.player.equip[loot.slot] = { n: loot.name, [loot.statType]: loot.val, color: loot.color };
                this.closeLoot();
            });
            btnSell.on('pointerdown', () => {
                this.player.gold += loot.price;
                this.closeLoot();
            });
        }

        closeLoot() {
            if(this.lootContainer) this.lootContainer.destroy();
            this.player.arm = Object.values(this.player.equip).reduce((a, b) => a + (b.arm || 0), 0);
            this.player.level++; 
            this.spawnMob(); 
            this.updateUI();
            this.lootActive = false;
        }

        // ==========================================
        // [БЛОК 3] СУПЕРСПОСОБНОСТИ (УЛЬТЫ)
        // ==========================================
        async useUlt() {
            if (this.player.mana < 100 || this.isAnimating || this.lootActive) return;
            this.player.mana = 0; this.isAnimating = true;
            let targets = [];
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                let t = this.grid[r][c];
                if (this.player.job === "Воин" && (t.type === 'Red' || t.type === 'Green')) targets.push(t);
                if (this.player.job === "Маг" && (t.type === 'Purple' || t.type === 'Yellow')) targets.push(t);
                if (this.player.job === "Лучник" && (t.type === 'Red' || t.type === 'Blue')) targets.push(t);
                if (this.player.job === "Ассасин" && (c % 2 === 0)) targets.push(t);
            }
            this.tweens.add({
                targets: targets, tintFill: true, tint: 0xffffff, duration: 800,
                onComplete: () => {
                    targets.forEach(t => {
                        this.applyEffect(t.type, 1.3);
                        this.grid[t.gridR][t.gridC] = null;
                        this.tweens.add({ targets: t, scale: 0, alpha: 0, duration: 500, onComplete: () => t.destroy() });
                    });
                    this.time.delayedCall(600, async () => {
                        await this.fillEmpty();
                        this.isAnimating = false; this.updateUI();
                        this.turn = "MOB"; this.time.delayedCall(600, () => this.mobAI());
                    });
                }
            });
        }

        // ==========================================
        // [БЛОК 4] ИГРОВОЕ ПОЛЕ И ТИЛЫ
        // ==========================================
        initGrid() {
            this.grid = []; 
            this.isAnimating = false; 
            this.comboCount = 0;

            // Создаем невидимую зону кликов строго по размеру сетки (8х8)
            const gridSize = 8 * TILE_S;
            this.gridArea = this.add.rectangle(OFFSET_X - TILE_S/2, OFFSET_Y - TILE_S/2, gridSize, gridSize, 0x000000, 0)
                .setOrigin(0, 0)
                .setInteractive();

            // Если кликнули по этой зоне, но не по плитке — сбрасываем выделение
            this.gridArea.on('pointerdown', () => {
                if (this.selectedTile) {
                    this.selectedTile.clearTint();
                    this.selectedTile = null;
                }
            });

            for (let r = 0; r < 8; r++) { 
                this.grid[r] = []; 
                for (let c = 0; c < 8; c++) this.spawnTile(r, c); 
            }
        }

        spawnTile(r, c, fromTop = false) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type;
            let attempts = 0;
            do { 
                type = Phaser.Utils.Array.GetRandom(types); 
                attempts++; 
            } while (attempts < 10 && (
                (c > 1 && this.grid[r][c-1] && this.grid[r][c-1].type === type && this.grid[r][c-2] && this.grid[r][c-2].type === type) || 
                (r > 1 && this.grid[r-1] && this.grid[r-1][c] && this.grid[r-1][c].type === type && this.grid[r-2] && this.grid[r-2][c] && this.grid[r-2][c].type === type)
            ));

            let tx = OFFSET_X + c * TILE_S, ty = OFFSET_Y + r * TILE_S;
            let tile = this.add.image(tx, fromTop ? ty - 500 : ty, `tile_${type}`).setDisplaySize(64, 64).setInteractive();
            tile.gridR = r; tile.gridC = c; tile.type = type;
            
            // Важно: событие pointerdown только на плитке
            tile.on('pointerdown', (pointer, localX, localY, event) => {
                event.stopPropagation(); // Запрещаем клику «проваливаться» дальше
                this.handleTileClick(tile);
            });

            this.grid[r][c] = tile;
            if (fromTop) this.tweens.add({ targets: tile, y: ty, duration: 500, ease: 'Bounce.easeOut' });
        }

        async handleTileClick(tile) {
            // Если анимация, ход моба или окно лута — игнорируем всё
            if (this.isAnimating || this.turn !== "PLAYER" || this.lootActive) return;

            if (!this.selectedTile) { 
                this.selectedTile = tile; 
                tile.setTint(0xffff00); 
            } else {
                if (this.selectedTile === tile) {
                    this.selectedTile.clearTint();
                    this.selectedTile = null;
                    return;
                }

                let dR = Math.abs(this.selectedTile.gridR - tile.gridR), dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    this.comboCount = 0;
                    if (!await this.checkMatches()) {
                        await this.swapTiles(this.selectedTile, tile);
                    } else { 
                        this.turn = "MOB"; 
                        this.time.delayedCall(800, () => this.mobAI()); 
                    }
                }
                if (this.selectedTile) this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        // ==========================================
        // [БЛОК 5] БОЕВАЯ ЛОГИКА И ИИ МОБА
        // ==========================================
        applyEffect(type, mult = 1) {
            if (this.lootActive) return;
            let comboBonus = 1 + (this.comboCount * 0.2);
            let totalMult = mult * comboBonus;
            let totalA = this.player.baseAtk + Object.values(this.player.equip).reduce((a, b) => a + (b.atk || 0), 0);
            
            if (type==='Red' || type==='Purple') this.mob.hp -= (totalA/5) * totalMult;
            if (type==='Green') this.player.hp = Math.min(this.player.maxHp, this.player.hp + (15 * totalMult));
            if (type==='Blue') this.player.mana = Math.min(100, this.player.mana + (10 * totalMult));
            if (type==='Yellow') this.player.gold += Math.floor(5 * totalMult);
            this.updateUI();
        }

        async mobAI() {
            if (this.mob.hp <= 0 || this.lootActive) return;
            let best = null;
            for (let r=0; r<8; r++) {
                for (let c=0; c<8; c++) {
                    let dirs = [[0,1],[1,0]];
                    for (let [dr, dc] of dirs) {
                        let nr=r+dr, nc=c+dc;
                        if (nr<8 && nc<8) {
                            let temp = this.grid.map(row => row.map(t => t ? t.type : null));
                            [temp[r][c], temp[nr][nc]] = [temp[nr][nc], temp[r][c]];
                            if (this.getMatchesAt(temp) > 0) best = {r1:r, c1:c, r2:nr, c2:nc};
                        }
                    }
                }
            }
            if (best) await this.swapTiles(this.grid[best.r1][best.c1], this.grid[best.r2][best.c2]);
            this.comboCount = 0;
            await this.checkMatches();
            this.turn = "PLAYER"; this.updateUI();
        }

        getMatchesAt(g) {
            let res = 0;
            for(let r=0; r<8; r++) for(let c=0; c<6; c++) if(g[r][c] && g[r][c]===g[r][c+1] && g[r][c]===g[r][c+2]) res++;
            for(let c=0; c<8; c++) for(let r=0; r<6; r++) if(g[r][c] && g[r][c]===g[r+1][c] && g[r][c]===g[r+2][c]) res++;
            return res;
        }

        // ==========================================
        // [БЛОК 6] ИНТЕРФЕЙС И ОБНОВЛЕНИЕ UI
        // ==========================================
        createUI() {
            // Фон панели UI (не интерактивный, чтобы не ловить клики)
            this.add.rectangle(175, 450, 310, 860, 0x191614).setStrokeStyle(2, 0xb48c46);
            
            this.add.image(175, 120, `hero_${this.player.job}`).setDisplaySize(140, 140);
            this.hpText = this.add.text(40, 210, "", { fontSize: '18px', fill: '#ff4444', fontStyle: 'bold' });
            this.hpBar = this.add.graphics();
            this.armBar = this.add.graphics();
            this.manaText = this.add.text(40, 280, "", { fontSize: '18px', fill: '#4444ff' });
            this.manaBar = this.add.graphics();
            this.goldText = this.add.text(40, 335, "", { fontSize: '22px', fill: '#ffd700' });
            
            this.ultBtn = this.add.rectangle(175, 410, 240, 50, 0x330033).setInteractive().setStrokeStyle(2, 0xaa00aa);
            this.add.text(175, 410, "СУПЕРУДАР", { fontSize: '20px', fill: '#fff' }).setOrigin(0.5);
            this.ultBtn.on('pointerdown', () => this.useUlt());
            
            this.add.text(40, 480, "ИНВЕНТАРЬ:", { fontSize: '18px', fill: '#ffffff', fontStyle: 'bold' });
            
            // Создаем массив текстовых объектов для каждого слота
            this.equipTexts = {};
            const slots = ['head', 'body', 'legs', 'weapon', 'ring', 'neck'];
            slots.forEach((s, i) => {
                this.equipTexts[s] = this.add.text(40, 510 + (i * 25), "", { fontSize: '15px' });
            });

            this.mobHpText = this.add.text(1050, 250, "", { fontSize: '22px', fill: '#ff0000' }).setOrigin(0.5);
            this.mobHpBar = this.add.graphics();
        }

        updateUI() {
            if (!this.player || !this.mob) return;
            let maxA = Object.values(this.player.equip).reduce((a, b) => a + (b.arm || 0), 0);
            
            this.hpText.setText(`ЖИЗНЬ: ${Math.floor(this.player.hp)} / ${this.player.maxHp}\nБРОНЯ: ${this.player.arm}`);
            this.hpBar.clear().fillStyle(0x440000).fillRect(40, 250, 270, 15).fillStyle(0xff0000).fillRect(40, 250, (Math.max(0, this.player.hp)/this.player.maxHp)*270, 15);
            
            if(maxA > 0) this.armBar.clear().fillStyle(0x00ffff).fillRect(40, 250, (this.player.arm/maxA)*270, 5);
            else this.armBar.clear();

            this.manaText.setText(`МАНА: ${this.player.mana}%`);
            this.manaBar.clear().fillStyle(0x000044).fillRect(40, 305, 270, 12).fillStyle(0x4444ff).fillRect(40, 305, (this.player.mana/100)*270, 12);
            this.goldText.setText(`ЗОЛОТО: ${this.player.gold}`);
            
            // Обновляем каждую строку инвентаря её цветом
            for (let k in this.player.equip) {
                let item = this.player.equip[k];
                if (this.equipTexts[k]) {
                    this.equipTexts[k].setText(`${item.n}: +${item.atk || 0} Атк / +${item.arm || 0} Бр`);
                    this.equipTexts[k].setFill(item.color || '#ffffff');
                }
            }
            
            this.mobHpText.setText(`${this.mob.name}\nHP: ${Math.floor(this.mob.hp)}`);
            this.mobHpBar.clear().fillStyle(0x440000).fillRect(945, 280, 210, 15).fillStyle(0xff0000).fillRect(945, 280, (Math.max(0, this.mob.hp)/this.mob.maxHp)*210, 15);
            
            if (this.mob.hp <= 0 && !this.lootActive) this.showLootWindow(this.generateLoot()); 
            if (this.player.hp <= 0) location.reload();
        }
    }

    new Phaser.Game({ type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, scene: [MainScene] });
    </script>
</body>
</html>
