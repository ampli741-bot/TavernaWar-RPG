<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Smart Cycle</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 3px solid #b48c46; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    const GW = 1200, GH = 900;
    const TILE_SIZE = 62, SPACING = 4;
    const OFFSET_X = 400, OFFSET_Y = 150;

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        preload() {
            // Загрузка ассетов
            const heroes = ['Воин', 'Маг', 'Лучник', 'Ассасин'];
            heroes.forEach(h => this.load.image(`hero_${h}`, `assets/hero_${h === 'Воин' ? 'warrior' : h === 'Маг' ? 'mage' : h === 'Лучник' ? 'archer' : 'assasin'}.png`));
            this.load.image('mob_icon', 'assets/hero_warrior.png');
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => this.load.image(`tile_${c}`, `assets/rune_${c.toLowerCase()}.png`));
        }

        create() { this.showMenu(); }

        showMenu() {
            this.add.text(GW/2, 100, "TAVERNA WAR RPG", { fontSize: '64px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            ["Воин", "Маг", "Лучник", "Ассасин"].forEach((name, i) => {
                let x = 300 * i + 150;
                let card = this.add.rectangle(x, 450, 260, 500, 0x1a1a1a).setInteractive().setStrokeStyle(2, 0xb48c46);
                this.add.image(x, 400, `hero_${name}`).setDisplaySize(180, 180);
                this.add.text(x, 600, name, { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
                card.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            this.initPlayer(job);
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.updateUI();
        }

        initPlayer(job) {
            const baseStats = { "Воин": 350, "Маг": 180, "Лучник": 220, "Ассасин": 200 };
            this.player = {
                job, maxHp: baseStats[job], hp: baseStats[job], atk: 30, mana: 0, gold: 0, level: 1,
                equipment: { "Оружие": { name: "Старый меч", stat: 10, rarity: "Обычное" } }
            };
        }

        spawnMob() {
            let lvl = this.player.level;
            this.mob = { 
                name: "Страж Этажа " + lvl, 
                maxHp: 200 + (lvl * 50), 
                hp: 200 + (lvl * 50), 
                atk: 20 + (lvl * 5) 
            };
            this.turn = "PLAYER";
            if (this.logText) this.logText.setText("Твой ход!");
        }

        initGrid() {
            this.grid = [];
            for (let r = 0; r < 8; r++) {
                this.grid[r] = [];
                for (let c = 0; c < 8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let tile = this.add.image(OFFSET_X + c*66, OFFSET_Y + r*66, `tile_${type}`).setDisplaySize(TILE_SIZE, TILE_SIZE).setInteractive();
            tile.gridR = r; tile.gridC = c; tile.type = type;
            tile.on('pointerdown', () => this.handleTileClick(tile));
            this.grid[r][c] = tile;
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.turn !== "PLAYER") return;
            if (!this.selectedTile) {
                this.selectedTile = tile;
                tile.setTint(0xffff00);
            } else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR);
                let dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    if (!await this.checkMatches()) {
                        await this.swapTiles(this.selectedTile, tile);
                    } else {
                        this.turn = "MOB";
                        this.updateUI();
                        this.time.delayedCall(1000, () => this.mobSmartTurn());
                    }
                }
                this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: OFFSET_X + c2*66, y: OFFSET_Y + r2*66, duration: 250 });
                this.tweens.add({ targets: t2, x: OFFSET_X + c1*66, y: OFFSET_Y + r1*66, duration: 250, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        async mobSmartTurn() {
            if (this.mob.hp <= 0) return;
            this.logText.setText("Ход противника...");
            
            // Простейший ИИ: ищем любую комбинацию
            let moveFound = false;
            for (let r=0; r<8; r++) {
                for (let c=0; c<7; c++) {
                    // Имитация "раздумий" и хода
                    if (Math.random() > 0.9) { 
                        await this.swapTiles(this.grid[r][c], this.grid[r][c+1]);
                        await this.checkMatches();
                        moveFound = true; break;
                    }
                }
                if (moveFound) break;
            }

            if (!moveFound) {
                // Если не нашел ход, просто бьет
                this.player.hp -= this.mob.atk;
                this.cameras.main.shake(200, 0.01);
            }

            this.turn = "PLAYER";
            this.logText.setText("Твой ход!");
            this.updateUI();
        }

        async checkMatches() {
            let toRemove = new Set();
            for(let r=0; r<8; r++) {
                for(let c=0; c<6; c++) {
                    if(this.grid[r][c].type === this.grid[r][c+1].type && this.grid[r][c].type === this.grid[r][c+2].type) {
                        toRemove.add(this.grid[r][c]); toRemove.add(this.grid[r][c+1]); toRemove.add(this.grid[r][c+2]);
                    }
                }
            }
            for(let c=0; c<8; c++) {
                for(let r=0; r<6; r++) {
                    if(this.grid[r][c].type === this.grid[r+1][c].type && this.grid[r][c].type === this.grid[r+2][c].type) {
                        toRemove.add(this.grid[r][c]); toRemove.add(this.grid[r+1][c]); toRemove.add(this.grid[r+2][c]);
                    }
                }
            }

            if (toRemove.size > 0) {
                toRemove.forEach(t => {
                    this.applyMatchEffect(t.type);
                    this.grid[t.gridR][t.gridC] = null;
                    t.destroy();
                });
                await this.fillEmpty();
                await this.checkMatches();
                return true;
            }
            return false;
        }

        applyMatchEffect(type) {
            if (this.turn === "PLAYER") {
                if (type === 'Red' || type === 'Purple') this.mob.hp -= 15;
                if (type === 'Green') this.player.hp = Math.min(this.player.maxHp, this.player.hp + 10);
                if (type === 'Blue') this.player.mana = Math.min(100, this.player.mana + 15);
                if (type === 'Yellow') this.player.gold += 5;
            } else {
                if (type === 'Red' || type === 'Purple') this.player.hp -= 10;
            }
        }

        async fillEmpty() {
            for(let c=0; c<8; c++) {
                for(let r=7; r>=0; r--) {
                    if(!this.grid[r][c]) {
                        for(let k=r-1; k>=0; k--) if(this.grid[k][c]) {
                            this.grid[r][c] = this.grid[k][c]; this.grid[k][c] = null;
                            this.grid[r][c].gridR = r; break;
                        }
                    }
                }
            }
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(!this.grid[r][c]) this.spawnTile(r, c);
            this.grid.flat().forEach(t => this.tweens.add({targets:t, x:OFFSET_X+t.gridC*66, y:OFFSET_Y+t.gridR*66, duration:200}));
            await new Promise(r => this.time.delayedCall(200, r));
        }

        showLoot() {
            this.turn = "LOOT";
            let overlay = this.add.container(GW/2, GH/2).setDepth(2000);
            let bg = this.add.rectangle(0, 0, 500, 400, 0x000, 0.9).setStrokeStyle(4, 0x00ff00);
            let itName = Phaser.Utils.Array.GetRandom(["Меч Крови", "Броня Света", "Кольцо Удачи"]);
            let stat = 10 + (this.player.level * 5);
            
            let t1 = this.add.text(0, -100, "МОНСТР ПОВЕРЖЕН!", { fontSize: '32px', fill: '#0f0' }).setOrigin(0.5);
            let t2 = this.add.text(0, 0, `Предмет: ${itName}\nБонус: +${stat}`, { fontSize: '24px', align: 'center' }).setOrigin(0.5);
            let btn = this.add.rectangle(0, 130, 200, 60, 0x006600).setInteractive();
            this.add.text(0, 130, "ДАЛЕЕ", { fontSize: '24px' }).setOrigin(0.5);

            overlay.add([bg, t1, t2, btn]);
            btn.on('pointerdown', () => {
                this.player.level++;
                this.player.atk += 5;
                overlay.destroy();
                this.spawnMob();
                this.updateUI();
            });
        }

        createUI() {
            this.add.rectangle(175, 450, 310, 860, 0x151515).setStrokeStyle(2, 0xb48c46);
            this.add.image(175, 150, `hero_${this.player.job}`).setDisplaySize(160, 160);
            this.hpText = this.add.text(40, 280, "", { fontSize: '22px', fill: '#ff4444' });
            this.goldText = this.add.text(40, 320, "", { fontSize: '22px', fill: '#ffd700' });
            this.logText = this.add.text(GW/2, 850, "", { fontSize: '28px', fill: '#00ff00' }).setOrigin(0.5);
            
            this.mobPanel = this.add.container(850, 50);
            this.mobIcon = this.add.image(150, 80, 'mob_icon').setDisplaySize(120, 120).setFlipX(true);
            this.mobHpText = this.add.text(0, 0, "", { fontSize: '24px', fill: '#ff0000' });
            this.mobPanel.add([this.mobIcon, this.mobHpText]);
        }

        updateUI() {
            this.hpText.setText(`HP: ${Math.max(0, Math.floor(this.player.hp))} / ${this.player.maxHp}`);
            this.goldText.setText(`ЗОЛОТО: ${this.player.gold}\nУРОВЕНЬ: ${this.player.level}`);
            this.mobHpText.setText(`${this.mob.name}\nHP: ${Math.max(0, Math.floor(this.mob.hp))} / ${this.mob.maxHp}`);
            
            if (this.mob.hp <= 0 && this.turn !== "LOOT") this.showLoot();
            if (this.player.hp <= 0) { alert("ГЕРОЙ ПОГИБ!"); location.reload(); }
        }
    }

    new Phaser.Game({ type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, scene: [MainScene] });
    </script>
</body>
</html>
