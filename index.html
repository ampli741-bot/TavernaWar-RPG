<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taverna War: Radiant Ultimates</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #0c0a08; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { border: 2px solid #b48c46; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <script>
    const GW = 1200, GH = 900, OFFSET_X = 400, OFFSET_Y = 140, TILE_S = 68;

    class MainScene extends Phaser.Scene {
        constructor() { super('MainScene'); }

        // ==========================================
        // [БЛОК 0] ЗАГРУЗКА РЕСУРСОВ
        // ==========================================
        preload() {
            this.load.image('hero_Воин', 'assets/hero_warrior.png');
            this.load.image('hero_Маг', 'assets/hero_mage.png');
            this.load.image('hero_Лучник', 'assets/archer.png');
            this.load.image('hero_Ассасин', 'assets/assasin.png');
            ['Red', 'Blue', 'Green', 'Purple', 'Yellow'].forEach(c => 
                this.load.image(`tile_${c}`, `assets/rune_${c.toLowerCase()}.png`)
            );
        }

        create() { this.showMenu(); }

        // ==========================================
        // [БЛОК 1] МЕНЮ И СТАРТ
        // ==========================================
        showMenu() {
            this.children.removeAll();
            this.add.text(GW/2, 100, "ВЫБЕРИТЕ ГЕРОЯ", { fontSize: '42px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            ["Воин", "Маг", "Лучник", "Ассасин"].forEach((name, i) => {
                let x = 300 * i + 150;
                let card = this.add.rectangle(x, 450, 260, 550, 0x1a1a1a).setInteractive().setStrokeStyle(2, 0xb48c46);
                this.add.image(x, 400, `hero_${name}`).setDisplaySize(200, 200);
                this.add.text(x, 600, name, { fontSize: '32px', fill: '#fff' }).setOrigin(0.5);
                card.on('pointerdown', () => this.startGame(name));
            });
        }

        startGame(job) {
            this.children.removeAll();
            const hps = { "Воин": 1400, "Маг": 720, "Лучник": 880, "Ассасин": 800 };
            this.player = {
                job, maxHp: hps[job], hp: hps[job], arm: 0, mana: 0, gold: 0, level: 1, baseAtk: 25,
                equip: {
                    head: { n: "Шлем", atk: 0, arm: 2, color: '#ffffff' },
                    body: { n: "Броня", atk: 0, arm: 5, color: '#ffffff' },
                    legs: { n: "Сапоги", atk: 0, arm: 2, color: '#ffffff' },
                    weapon: { n: "Меч", atk: 12, arm: 0, color: '#ffffff' },
                    ring: { n: "Кольцо", atk: 2, arm: 0, color: '#ffffff' },
                    neck: { n: "Амулет", atk: 0, arm: 0, color: '#ffffff' }
                }
            };
            this.spawnMob();
            this.initGrid();
            this.createUI();
            this.updateUI();
        }

        // ==========================================
        // [БЛОК 2] МОБЫ И ЛУТ (ЦИКЛ ИГРЫ)
        // ==========================================
        spawnMob() {
            let lvl = this.player.level;
            this.mob = { 
                name: "Монстр Ур." + lvl, 
                maxHp: 100 + (lvl*65), hp: 100 + (lvl*65), 
                atk: 10 + (lvl*8) 
            };
            this.turn = "PLAYER";
            this.lootActive = false;
        }

        generateLoot() {
            const rarities = [
                { n: 'Обычный', c: '#ffffff', mult: 1, chance: 60 },
                { n: 'Редкий', c: '#00ff00', mult: 1.8, chance: 20 },
                { n: 'Эпический', c: '#800080', mult: 3, chance: 15 },
                { n: 'Легендарный', c: '#ff8c00', mult: 5, chance: 5 }
            ];
            let rand = Phaser.Math.Between(1, 100), cum = 0, rarity = rarities[0];
            for (let r of rarities) { cum += r.chance; if (rand <= cum) { rarity = r; break; } }
            
            const slots = [
                {n:'Шлем', s:'head', st:'arm'}, {n:'Доспех', s:'body', st:'arm'}, 
                {n:'Меч', s:'weapon', st:'atk'}, {n:'Кольцо', s:'ring', st:'atk'}
            ];
            let item = Phaser.Utils.Array.GetRandom(slots);
            let val = Math.floor(this.player.level * 4 * rarity.mult);
            return { 
                name: item.n, slot: item.s, statType: item.st, 
                val: val, rarity: rarity.n, color: rarity.c, price: val * 3 
            };
        }

        showLootWindow(loot) {
            this.lootActive = true;
            this.addLog(`ПОБЕДА! Ур. ${this.player.level} пройден.`, '#00ff00');
            
            this.lootContainer = this.add.container(GW/2, GH/2).setDepth(5000);
            let bg = this.add.rectangle(0, 0, 550, 450, 0x000000, 0.95).setStrokeStyle(4, 0xb48c46).setInteractive();
            let title = this.add.text(0, -160, "ТРОФЕЙ НАЙДЕН!", { fontSize: '36px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(0.5);
            let itemTxt = this.add.text(0, -60, `${loot.rarity} ${loot.name}`, { fontSize: '32px', fill: loot.color, fontStyle: 'bold' }).setOrigin(0.5);
            let statTxt = this.add.text(0, 20, `Показатель: +${loot.val} ${loot.statType === 'arm' ? 'Брони' : 'Атаки'}`, { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
            
            let btn = this.add.rectangle(0, 140, 220, 70, 0x224422).setInteractive().setStrokeStyle(2, 0x00ff00);
            let btnTxt = this.add.text(0, 140, "НАДЕТЬ И ДАЛЕЕ", { fontSize: '20px', fontStyle: 'bold' }).setOrigin(0.5);

            this.lootContainer.add([bg, title, itemTxt, statTxt, btn, btnTxt]);

            btn.on('pointerdown', () => {
                // Экипируем предмет
                this.player.equip[loot.slot] = { n: loot.name, [loot.statType]: loot.val, color: loot.color };
                this.player.level++;
                this.player.hp = this.player.maxHp; // Лечим при переходе
                this.lootContainer.destroy();
                
                // Перезапуск боя
                this.spawnMob();
                this.updateUI();
                this.addLog(`--- УРОВЕНЬ ${this.player.level} ---`, '#ffffff');
            });
        }

        // ==========================================
        // [БЛОК 3] СУПЕРСПОСОБНОСТИ
        // ==========================================
        async useUlt() {
            if (this.player.mana < 100 || this.isAnimating || this.lootActive) return;
            this.player.mana = 0;
            this.addLog("УЛЬТИМАТИВНЫЙ УДАР!", '#ffff00');
            
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    if (Phaser.Math.Between(0,100) > 60) {
                        if(this.grid[r][c]) {
                            this.applyEffect(this.grid[r][c].type, 1.2);
                            this.grid[r][c].destroy();
                            this.grid[r][c] = null;
                        }
                    }
                }
            }
            await this.fillEmpty();
            this.turn = "MOB";
            this.time.delayedCall(800, () => this.mobAI());
        }

        // ==========================================
        // [БЛОК 4] СЕТКА И ТИЛЫ
        // ==========================================
        initGrid() {
            this.grid = []; this.isAnimating = false;
            for (let r = 0; r < 8; r++) {
                this.grid[r] = [];
                for (let c = 0; c < 8; c++) this.spawnTile(r, c);
            }
        }

        spawnTile(r, c, fromTop = false) {
            const types = ['Red', 'Blue', 'Green', 'Purple', 'Yellow'];
            let type = Phaser.Utils.Array.GetRandom(types);
            let tx = OFFSET_X + c * TILE_S, ty = OFFSET_Y + r * TILE_S;
            let tile = this.add.image(tx, fromTop ? ty - 500 : ty, `tile_${type}`).setDisplaySize(64, 64).setInteractive().setDepth(2);
            tile.gridR = r; tile.gridC = c; tile.type = type;
            
            tile.on('pointerdown', (p, x, y, e) => {
                if(this.lootActive) return;
                if(p.x > 366 && p.x < 910) { e.stopPropagation(); this.handleTileClick(tile); }
            });
            
            this.grid[r][c] = tile;
            if (fromTop) this.tweens.add({ targets: tile, y: ty, duration: 400, ease: 'Power2' });
        }

        async handleTileClick(tile) {
            if (this.isAnimating || this.turn !== "PLAYER" || this.lootActive) return;
            if (!this.selectedTile) { this.selectedTile = tile; tile.setTint(0xffff00); }
            else {
                let dR = Math.abs(this.selectedTile.gridR - tile.gridR), dC = Math.abs(this.selectedTile.gridC - tile.gridC);
                if (dR + dC === 1) {
                    await this.swapTiles(this.selectedTile, tile);
                    if (!await this.checkMatches()) await this.swapTiles(this.selectedTile, tile);
                    else { 
                        this.turn = "MOB"; 
                        this.time.delayedCall(800, () => this.mobAI()); 
                    }
                }
                if (this.selectedTile) this.selectedTile.clearTint();
                this.selectedTile = null;
            }
        }

        async swapTiles(t1, t2) {
            this.isAnimating = true;
            let r1 = t1.gridR, c1 = t1.gridC, r2 = t2.gridR, c2 = t2.gridC;
            this.grid[r1][c1] = t2; this.grid[r2][c2] = t1;
            t1.gridR = r2; t1.gridC = c2; t2.gridR = r1; t2.gridC = c1;
            return new Promise(res => {
                this.tweens.add({ targets: t1, x: OFFSET_X+c2*TILE_S, y: OFFSET_Y+r2*TILE_S, duration: 200 });
                this.tweens.add({ targets: t2, x: OFFSET_X+c1*TILE_S, y: OFFSET_Y+r1*TILE_S, duration: 200, onComplete: () => { this.isAnimating = false; res(); } });
            });
        }

        async checkMatches() {
            let toRem = new Set();
            for(let r=0; r<8; r++) for(let c=0; c<6; c++) if(this.grid[r][c] && this.grid[r][c+1] && this.grid[r][c+2] && this.grid[r][c].type === this.grid[r][c+1].type && this.grid[r][c].type === this.grid[r][c+2].type) [0,1,2].forEach(i=>toRem.add(this.grid[r][c+i]));
            for(let c=0; c<8; c++) for(let r=0; r<6; r++) if(this.grid[r][c] && this.grid[r+1][c] && this.grid[r+2][c] && this.grid[r][c].type === this.grid[r+1][c].type && this.grid[r][c].type === this.grid[r+2][c].type) [0,1,2].forEach(i=>toRem.add(this.grid[r+i][c]));
            if (toRem.size > 0) { 
                toRem.forEach(t => { if(t) { this.applyEffect(t.type); this.grid[t.gridR][t.gridC] = null; t.destroy(); }});
                await this.fillEmpty(); await this.checkMatches(); return true; 
            }
            return false;
        }

        async fillEmpty() {
            for(let c=0; c<8; c++) {
                let empty = 0;
                for(let r=7; r>=0; r--) { 
                    if(!this.grid[r][c]) empty++; 
                    else if(empty > 0) { 
                        let t = this.grid[r][c]; this.grid[r+empty][c] = t; this.grid[r][c] = null; t.gridR = r+empty; 
                        this.tweens.add({ targets: t, y: OFFSET_Y+t.gridR*TILE_S, duration: 300 }); 
                    } 
                }
                for(let i=0; i<empty; i++) this.spawnTile(i, c, true);
            }
            await new Promise(res => this.time.delayedCall(350, res));
        }

        // ==========================================
        // [БЛОК 5] БОЕВАЯ ЛОГИКА И ИИ
        // ==========================================
        applyEffect(type, mult = 1) {
            if(this.lootActive) return;
            let totalA = this.player.baseAtk + Object.values(this.player.equip).reduce((a, b) => a + (b.atk || 0), 0);
            if (type === 'Red' || type === 'Purple') { this.mob.hp -= Math.floor(totalA/6 * mult); }
            if (type === 'Green') { this.player.hp = Math.min(this.player.maxHp, this.player.hp + 12); }
            if (type === 'Blue') { this.player.mana = Math.min(100, this.player.mana + 8); }
            if (type === 'Yellow') { this.player.gold += 5; }
            this.updateUI();
        }

        async mobAI() {
            if (this.mob.hp <= 0 || this.lootActive) return;
            
            // Имитация хода моба
            let r = Phaser.Math.Between(0, 7), c = Phaser.Math.Between(0, 6);
            if(this.grid[r][c] && this.grid[r][c+1]) {
                await this.swapTiles(this.grid[r][c], this.grid[r][c+1]);
                await this.checkMatches();
            }

            let dmg = Math.max(2, this.mob.atk - this.player.arm);
            this.player.hp -= dmg;
            this.addLog(`${this.mob.name} атакует: -${dmg} HP`, '#ff4444');
            
            this.turn = "PLAYER"; 
            this.updateUI();
        }

        // ==========================================
        // [БЛОК 6] ИНТЕРФЕЙС И ЛОГИ
        // ==========================================
        createUI() {
            // Левая панель
            this.add.rectangle(0, 0, 366, GH, 0x191614).setOrigin(0,0).setDepth(10).setStrokeStyle(2, 0xb48c46);
            // Правая панель
            this.add.rectangle(910, 0, 290, GH, 0x191614).setOrigin(0,0).setDepth(10).setStrokeStyle(2, 0xb48c46);
            
            this.logTexts = [];
            for (let i = 0; i < 5; i++) {
                this.logTexts.push(this.add.text(GW/2, 730 + (i * 22), "", { fontSize: '18px', fontStyle: 'bold' }).setOrigin(0.5).setDepth(11));
            }

            this.hpText = this.add.text(40, 210, "", { fontSize: '18px', fill: '#ff4444', fontStyle: 'bold' }).setDepth(11);
            this.goldText = this.add.text(40, 335, "", { fontSize: '22px', fill: '#ffd700' }).setDepth(11);
            
            this.ultBtn = this.add.rectangle(183, 410, 260, 50, 0x440044).setInteractive().setDepth(11).setStrokeStyle(2, 0xff00ff);
            this.add.text(183, 410, "СУПЕРУДАР (100%)", { fontSize: '18px', fill: '#fff' }).setOrigin(0.5).setDepth(11);
            this.ultBtn.on('pointerdown', () => this.useUlt());

            this.equipTexts = {};
            ['head', 'body', 'legs', 'weapon', 'ring', 'neck'].forEach((s, i) => {
                this.equipTexts[s] = this.add.text(40, 510 + (i * 25), "", { fontSize: '15px' }).setDepth(11);
            });

            this.mobHpText = this.add.text(1055, 230, "", { fontSize: '22px', fill: '#ff0000', align: 'center' }).setOrigin(0.5).setDepth(11);
        }

        updateUI() {
            if (!this.player || !this.mob) return;
            
            this.player.arm = Object.values(this.player.equip).reduce((a, b) => a + (b.arm || 0), 0);
            this.hpText.setText(`HP: ${Math.floor(this.player.hp)} / ${this.player.maxHp}\nARMOR: ${this.player.arm}\nMANA: ${this.player.mana}%`);
            this.goldText.setText(`GOLD: ${this.player.gold}`);
            
            for (let k in this.player.equip) { 
                let itm = this.player.equip[k]; 
                this.equipTexts[k].setText(`${itm.n}: +${itm.atk || 0} Atk / +${itm.arm || 0} Arm`).setFill(itm.color); 
            }
            
            this.mobHpText.setText(`${this.mob.name}\nHP: ${Math.max(0, Math.floor(this.mob.hp))}`);
            
            // Проверка на смерть моба
            if (this.mob.hp <= 0 && !this.lootActive) {
                this.showLootWindow(this.generateLoot());
            }

            if (this.player.hp <= 0) {
                alert("ГЕРОЙ ПАЛ! Игра будет перезапущена.");
                location.reload();
            }
        }

        addLog(msg, color) {
            this.logTexts.unshift(this.logTexts.pop());
            this.logTexts[0].setText(msg).setFill(color).setAlpha(0);
            this.tweens.add({ targets: this.logTexts[0], alpha: 1, duration: 200 });
            this.logTexts.forEach((t, i) => t.setY(730 + (i * 22)));
        }
    }

    new Phaser.Game({ type: Phaser.AUTO, parent: 'game-container', width: GW, height: GH, scene: [MainScene] });
    </script>
</body>
</html>
